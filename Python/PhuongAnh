


def ve_bieu_do_tron():
    """Bi·ªÉu ƒë·ªì tr√≤n t·ªïng theo danh m·ª•c"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT Danh_muc, SUM(So_tien) FROM ChiTieu WHERE UserID = %s GROUP BY Danh_muc",
                       (current_user_id,))
        data = cursor.fetchall()
        conn.close()
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        return

    if not data:
        messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
        return

    danh_mucs = [row[0] if row[0] else "Kh√°c" for row in data]
    tong_tien = [float(row[1] or 0) for row in data]

    plt.figure(figsize=(6, 6))
    plt.pie(tong_tien, labels=danh_mucs, autopct='%1.1f%%')
    plt.title("Bi·ªÉu ƒë·ªì chi ti√™u theo danh m·ª•c")

    # TH√äM D√íNG N√ÄY: ƒê·∫£m b·∫£o c·ª≠a s·ªï matplotlib hi·ªÉn th·ªã tr√™n c√πng
    plt.gcf().canvas.manager.window.attributes('-topmost', 1)
    plt.gcf().canvas.manager.window.attributes('-topmost', 0)  # Reset sau khi focus
    plt.show()

def ve_bieu_do_xu_huong():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï ch·ªçn danh m·ª•c ƒë·ªÉ xem bi·ªÉu ƒë·ªì xu h∆∞·ªõng"""
    # L·∫•y danh s√°ch danh m·ª•c c√≥ d·ªØ li·ªáu
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT DISTINCT Danh_muc FROM ChiTieu WHERE UserID = %s ORDER BY Danh_muc",
                       (current_user_id,))
        categories = [row[0] if row[0] else "Kh√°c" for row in cursor.fetchall()]
        conn.close()

        if not categories:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu:\n{e}")
        return

    # T·∫°o c·ª≠a s·ªï ch·ªçn danh m·ª•c
    select_window = tk.Toplevel(root)
    select_window.title("Ch·ªçn danh m·ª•c xem xu h∆∞·ªõng")
    select_window.geometry("400x250")
    select_window.transient(root)
    select_window.grab_set()
    select_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    select_window.update_idletasks()
    x = (select_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (select_window.winfo_screenheight() // 2) - (250 // 2)
    select_window.geometry(f"400x250+{x}+{y}")

    frame = tk.Frame(select_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn danh m·ª•c:", font=("Arial", 12, "bold")).pack(pady=(0, 10))

    selected_category = tk.StringVar()
    selected_category.set(categories[0])

    combo_category = ttk.Combobox(frame, textvariable=selected_category, values=categories,
                                  state="readonly", width=30)
    combo_category.pack(pady=10)

    tk.Button(frame, text="Xem t·∫•t c·∫£ danh m·ª•c",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(None)],
              width=30, height=2).pack(pady=5)

    tk.Button(frame, text="Xem danh m·ª•c ƒë√£ ch·ªçn",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(selected_category.get())],
              width=30, height=2).pack(pady=5)


def ve_bieu_do_col_line(danh_muc=None):
    """V·∫Ω bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng th·ªÉ hi·ªán xu h∆∞·ªõng ti√™u d√πng theo th√°ng"""
    try:
        conn = get_connection()
        cursor = conn.cursor()

        if danh_muc:
            # L·∫•y d·ªØ li·ªáu theo th√°ng cho danh m·ª•c c·ª• th·ªÉ
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s AND Danh_muc = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay)
                ORDER BY YEAR(Ngay), MONTH(Ngay)
            """
            cursor.execute(query, (current_user_id, danh_muc))
            title = f"Xu h∆∞·ªõng chi ti√™u - {danh_muc}"
        else:
            # L·∫•y d·ªØ li·ªáu theo th√°ng cho t·∫•t c·∫£ danh m·ª•c
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, Danh_muc, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay), Danh_muc
                ORDER BY YEAR(Ngay), MONTH(Ngay), Danh_muc
            """
            cursor.execute(query, (current_user_id,))
            title = "Xu h∆∞·ªõng chi ti√™u - T·∫•t c·∫£ danh m·ª•c"

        data = cursor.fetchall()
        conn.close()

        if not data:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return

        # X·ª≠ l√Ω d·ªØ li·ªáu
        if danh_muc:
            # D·ªØ li·ªáu cho m·ªôt danh m·ª•c
            thang_nam = [f"{int(row[1]):02d}/{int(row[0])}" for row in data]
            tong_tien = [float(row[2]) for row in data]

            fig, ax = plt.subplots(figsize=(12, 6))

            # Bi·ªÉu ƒë·ªì c·ªôt
            bars = ax.bar(thang_nam, tong_tien, color='steelblue', alpha=0.7, label='Chi ti√™u')

            # Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
            ax.plot(thang_nam, tong_tien, color='red', marker='o', linewidth=2, markersize=8, label='Xu h∆∞·ªõng')

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.legend()
            ax.grid(True, alpha=0.3)

            # Xoay nh√£n tr·ª•c x ƒë·ªÉ d·ªÖ ƒë·ªçc
            plt.xticks(rotation=45, ha='right')

            # Th√™m gi√° tr·ªã tr√™n c·ªôt
            for bar in bars:
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width() / 2., height,
                        f'{height:,.0f}',
                        ha='center', va='bottom', fontsize=8)

            plt.tight_layout()

        else:
            # D·ªØ li·ªáu cho nhi·ªÅu danh m·ª•c
            # T·ªï ch·ª©c d·ªØ li·ªáu theo th√°ng/nƒÉm v√† danh m·ª•c
            data_dict = {}
            all_months = set()

            for row in data:
                nam, thang, danh_muc_item, tong_tien = row
                month_key = f"{int(thang):02d}/{int(nam)}"
                all_months.add(month_key)

                if danh_muc_item not in data_dict:
                    data_dict[danh_muc_item] = {}
                data_dict[danh_muc_item][month_key] = float(tong_tien)

            # S·∫Øp x·∫øp th√°ng (theo nƒÉm v√† th√°ng)
            def sort_key(month_str):
                parts = month_str.split('/')
                return (int(parts[1]), int(parts[0]))  # (nƒÉm, th√°ng)

            sorted_months = sorted(all_months, key=sort_key)

            # T·∫°o bi·ªÉu ƒë·ªì
            fig, ax = plt.subplots(figsize=(14, 7))

            # M√†u s·∫Øc cho c√°c danh m·ª•c
            colors = plt.cm.tab10(range(len(data_dict)))

            x = range(len(sorted_months))
            width = 0.8 / len(data_dict)  # ƒê·ªô r·ªông c·ªôt

            # V·∫Ω bi·ªÉu ƒë·ªì c·ªôt cho t·ª´ng danh m·ª•c (kh√¥ng hi·ªÉn th·ªã trong legend)
            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                offset = (idx - len(data_dict) / 2 + 0.5) * width
                bars = ax.bar([i + offset for i in x], values, width,
                              color=color, alpha=0.7)

            # V·∫Ω bi·ªÉu ƒë·ªì ƒë∆∞·ªùng cho t·ª´ng danh m·ª•c (xu h∆∞·ªõng c·ªßa t·ª´ng danh m·ª•c)
            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                ax.plot(x, values, color=color, marker='o', linewidth=2,
                        markersize=6, label=danh_muc_item,
                        linestyle='--', zorder=5, alpha=0.8)

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.set_xticks(x)
            ax.set_xticklabels(sorted_months, rotation=45, ha='right')
            ax.legend(loc='upper left')
            ax.grid(True, alpha=0.3)

            plt.tight_layout()

        # TH√äM ƒêO·∫†N CODE N√ÄY: ƒê·∫£m b·∫£o c·ª≠a s·ªï matplotlib hi·ªÉn th·ªã tr√™n c√πng
        plt.gcf().canvas.manager.window.attributes('-topmost', 1)
        plt.gcf().canvas.manager.window.attributes('-topmost', 0)  # Reset sau khi focus
        plt.show()

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        import traceback
        traceback.print_exc()

def select_category(category, category_buttons):
    """X·ª≠ l√Ω khi ch·ªçn danh m·ª•c chi ti√™u"""
    global selected_category
    selected_category = category  # L∆∞u l·∫°i danh m·ª•c ƒë√£ ch·ªçn

    # ƒê·∫∑t l·∫°i m√†u cho t·∫•t c·∫£ n√∫t
    for cat, btn in category_buttons.items():
        btn.configure(bg=CATEGORY_COLORS.get(cat, "#FFFFFF"), fg="#333333", relief=tk.RAISED)

    # T√¥ s√°ng n√∫t ƒë∆∞·ª£c ch·ªçn
    category_buttons[category].configure(bg="#4FC3A1", fg="white", relief=tk.SUNKEN)



def show_chart_window():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï bi·ªÉu ƒë·ªì ri√™ng bi·ªát"""
    chart_window = tk.Toplevel(root)
    chart_window.title("Bi·ªÉu ƒë·ªì chi ti√™u")
    chart_window.geometry("500x400")
    chart_window.configure(bg="#F5F5F5")
    chart_window.transient(root)
    chart_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    chart_window.update_idletasks()
    x = (chart_window.winfo_screenwidth() // 2) - (500 // 2)
    y = (chart_window.winfo_screenheight() // 2) - (400 // 2)
    chart_window.geometry(f"500x400+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(chart_window, text="üìà BI·ªÇU ƒê·ªí CHI TI√äU", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(30, 30))

    # Frame ch√≠nh
    main_frame = tk.Frame(chart_window, bg="#F5F5F5")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=50, pady=20)

    btn_frame = tk.Frame(main_frame, bg="#F5F5F5")
    btn_frame.pack()

    btn1 = create_rounded_button(btn_frame, "üìä Bi·ªÉu ƒë·ªì tr√≤n", ve_bieu_do_tron, "#FFB6C1", "#FFFFFF", 25, 2)
    btn1.pack(pady=10, fill=tk.X)

    btn2 = create_rounded_button(btn_frame, "üìà Bi·ªÉu ƒë·ªì xu h∆∞·ªõng", ve_bieu_do_xu_huong, "#DDA0DD", "#FFFFFF", 25, 2)
    btn2.pack(pady=10, fill=tk.X)

def get_total_expenses():
    """L·∫•y t·ªïng chi ti√™u c·ªßa user hi·ªán t·∫°i"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT SUM(So_tien) FROM ChiTieu WHERE UserID = %s", (current_user_id,))
        result = cursor.fetchone()
        conn.close()
        return float(result[0] or 0)
    except:
        return 0

def get_expense_count():
    """L·∫•y s·ªë l∆∞·ª£ng chi ti√™u"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM ChiTieu WHERE UserID = %s", (current_user_id,))
        result = cursor.fetchone()
        conn.close()
        return result[0] or 0
    except:
        return 0

def get_monthly_expense():
    """L·∫•y chi ti√™u th√°ng hi·ªán t·∫°i"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        current_month = datetime.now().month
        current_year = datetime.now().year
        cursor.execute("SELECT SUM(So_tien) FROM ChiTieu WHERE UserID = %s AND MONTH(Ngay) = %s AND YEAR(Ngay) = %s",
                       (current_user_id, current_month, current_year))
        result = cursor.fetchone()
        conn.close()
        return float(result[0] or 0)
    except:
        return 0
