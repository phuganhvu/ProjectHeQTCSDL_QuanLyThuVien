
def ve_bieu_do():
    """Hi·ªÉn th·ªã menu ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì"""
    choice_window = tk.Toplevel(root)
    choice_window.title("Ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì")
    choice_window.geometry("400x200")
    choice_window.transient(root)
    choice_window.grab_set()
    choice_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    choice_window.update_idletasks()
    x = (choice_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (choice_window.winfo_screenheight() // 2) - (200 // 2)
    choice_window.geometry(f"400x200+{x}+{y}")

    frame = tk.Frame(choice_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì:", font=("Arial", 12, "bold")).pack(pady=(0, 20))

    tk.Button(frame, text="Bi·ªÉu ƒë·ªì tr√≤n (T·ªïng theo danh m·ª•c)",
              command=lambda: [choice_window.destroy(), ve_bieu_do_tron()],
              width=40, height=2).pack(pady=5)

    tk.Button(frame, text="Bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng (Xu h∆∞·ªõng theo th√°ng)",
              command=lambda: [choice_window.destroy(), ve_bieu_do_xu_huong()],
              width=40, height=2).pack(pady=5)


def ve_bieu_do_tron():
    """Bi·ªÉu ƒë·ªì tr√≤n t·ªïng theo danh m·ª•c"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT Danh_muc, SUM(So_tien) FROM ChiTieu WHERE UserID = %s GROUP BY Danh_muc",
                       (current_user_id,))
        data = cursor.fetchall()
        conn.close()
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        return

    if not data:
        messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
        return

    danh_mucs = [row[0] if row[0] else "Kh√°c" for row in data]
    tong_tien = [float(row[1] or 0) for row in data]

    plt.figure(figsize=(6, 6))
    plt.pie(tong_tien, labels=danh_mucs, autopct='%1.1f%%')
    plt.title("Bi·ªÉu ƒë·ªì chi ti√™u theo danh m·ª•c")

    # TH√äM D√íNG N√ÄY: ƒê·∫£m b·∫£o c·ª≠a s·ªï matplotlib hi·ªÉn th·ªã tr√™n c√πng
    plt.gcf().canvas.manager.window.attributes('-topmost', 1)
    plt.gcf().canvas.manager.window.attributes('-topmost', 0)  # Reset sau khi focus
    plt.show()

def ve_bieu_do_xu_huong():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï ch·ªçn danh m·ª•c ƒë·ªÉ xem bi·ªÉu ƒë·ªì xu h∆∞·ªõng"""
    # L·∫•y danh s√°ch danh m·ª•c c√≥ d·ªØ li·ªáu
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT DISTINCT Danh_muc FROM ChiTieu WHERE UserID = %s ORDER BY Danh_muc",
                       (current_user_id,))
        categories = [row[0] if row[0] else "Kh√°c" for row in cursor.fetchall()]
        conn.close()

        if not categories:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu:\n{e}")
        return

    # T·∫°o c·ª≠a s·ªï ch·ªçn danh m·ª•c
    select_window = tk.Toplevel(root)
    select_window.title("Ch·ªçn danh m·ª•c xem xu h∆∞·ªõng")
    select_window.geometry("400x250")
    select_window.transient(root)
    select_window.grab_set()
    select_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    select_window.update_idletasks()
    x = (select_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (select_window.winfo_screenheight() // 2) - (250 // 2)
    select_window.geometry(f"400x250+{x}+{y}")

    frame = tk.Frame(select_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn danh m·ª•c:", font=("Arial", 12, "bold")).pack(pady=(0, 10))

    selected_category = tk.StringVar()
    selected_category.set(categories[0])

    combo_category = ttk.Combobox(frame, textvariable=selected_category, values=categories,
                                  state="readonly", width=30)
    combo_category.pack(pady=10)

    tk.Button(frame, text="Xem t·∫•t c·∫£ danh m·ª•c",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(None)],
              width=30, height=2).pack(pady=5)

    tk.Button(frame, text="Xem danh m·ª•c ƒë√£ ch·ªçn",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(selected_category.get())],
              width=30, height=2).pack(pady=5)


def ve_bieu_do_col_line(danh_muc=None):
    """V·∫Ω bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng th·ªÉ hi·ªán xu h∆∞·ªõng ti√™u d√πng theo th√°ng"""
    try:
        conn = get_connection()
        cursor = conn.cursor()

        if danh_muc:
            # L·∫•y d·ªØ li·ªáu theo th√°ng cho danh m·ª•c c·ª• th·ªÉ
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s AND Danh_muc = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay)
                ORDER BY YEAR(Ngay), MONTH(Ngay)
            """
            cursor.execute(query, (current_user_id, danh_muc))
            title = f"Xu h∆∞·ªõng chi ti√™u - {danh_muc}"
        else:
            # L·∫•y d·ªØ li·ªáu theo th√°ng cho t·∫•t c·∫£ danh m·ª•c
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, Danh_muc, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay), Danh_muc
                ORDER BY YEAR(Ngay), MONTH(Ngay), Danh_muc
            """
            cursor.execute(query, (current_user_id,))
            title = "Xu h∆∞·ªõng chi ti√™u - T·∫•t c·∫£ danh m·ª•c"

        data = cursor.fetchall()
        conn.close()

        if not data:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return

        # X·ª≠ l√Ω d·ªØ li·ªáu
        if danh_muc:
            # D·ªØ li·ªáu cho m·ªôt danh m·ª•c
            thang_nam = [f"{int(row[1]):02d}/{int(row[0])}" for row in data]
            tong_tien = [float(row[2]) for row in data]

            fig, ax = plt.subplots(figsize=(12, 6))

            # Bi·ªÉu ƒë·ªì c·ªôt
            bars = ax.bar(thang_nam, tong_tien, color='steelblue', alpha=0.7, label='Chi ti√™u')

            # Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
            ax.plot(thang_nam, tong_tien, color='red', marker='o', linewidth=2, markersize=8, label='Xu h∆∞·ªõng')

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.legend()
            ax.grid(True, alpha=0.3)

            # Xoay nh√£n tr·ª•c x ƒë·ªÉ d·ªÖ ƒë·ªçc
            plt.xticks(rotation=45, ha='right')

            # Th√™m gi√° tr·ªã tr√™n c·ªôt
            for bar in bars:
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width() / 2., height,
                        f'{height:,.0f}',
                        ha='center', va='bottom', fontsize=8)

            plt.tight_layout()

        else:
            # D·ªØ li·ªáu cho nhi·ªÅu danh m·ª•c
            # T·ªï ch·ª©c d·ªØ li·ªáu theo th√°ng/nƒÉm v√† danh m·ª•c
            data_dict = {}
            all_months = set()

            for row in data:
                nam, thang, danh_muc_item, tong_tien = row
                month_key = f"{int(thang):02d}/{int(nam)}"
                all_months.add(month_key)

                if danh_muc_item not in data_dict:
                    data_dict[danh_muc_item] = {}
                data_dict[danh_muc_item][month_key] = float(tong_tien)

            # S·∫Øp x·∫øp th√°ng (theo nƒÉm v√† th√°ng)
            def sort_key(month_str):
                parts = month_str.split('/')
                return (int(parts[1]), int(parts[0]))  # (nƒÉm, th√°ng)

            sorted_months = sorted(all_months, key=sort_key)

            # T·∫°o bi·ªÉu ƒë·ªì
            fig, ax = plt.subplots(figsize=(14, 7))

            # M√†u s·∫Øc cho c√°c danh m·ª•c
            colors = plt.cm.tab10(range(len(data_dict)))

            x = range(len(sorted_months))
            width = 0.8 / len(data_dict)  # ƒê·ªô r·ªông c·ªôt

            # V·∫Ω bi·ªÉu ƒë·ªì c·ªôt cho t·ª´ng danh m·ª•c (kh√¥ng hi·ªÉn th·ªã trong legend)
            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                offset = (idx - len(data_dict) / 2 + 0.5) * width
                bars = ax.bar([i + offset for i in x], values, width,
                              color=color, alpha=0.7)

            # V·∫Ω bi·ªÉu ƒë·ªì ƒë∆∞·ªùng cho t·ª´ng danh m·ª•c (xu h∆∞·ªõng c·ªßa t·ª´ng danh m·ª•c)
            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                ax.plot(x, values, color=color, marker='o', linewidth=2,
                        markersize=6, label=danh_muc_item,
                        linestyle='--', zorder=5, alpha=0.8)

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.set_xticks(x)
            ax.set_xticklabels(sorted_months, rotation=45, ha='right')
            ax.legend(loc='upper left')
            ax.grid(True, alpha=0.3)

            plt.tight_layout()

        # TH√äM ƒêO·∫†N CODE N√ÄY: ƒê·∫£m b·∫£o c·ª≠a s·ªï matplotlib hi·ªÉn th·ªã tr√™n c√πng
        plt.gcf().canvas.manager.window.attributes('-topmost', 1)
        plt.gcf().canvas.manager.window.attributes('-topmost', 0)  # Reset sau khi focus
        plt.show()

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        import traceback
        traceback.print_exc()
import tkinter as tk
from tkinter import messagebox, ttk
from database import get_connection, init_database, check_login, register_user, get_all_users, delete_user
import matplotlib.pyplot as plt
from tkcalendar import DateEntry
from datetime import datetime

CATEGORIES = ["ƒÇn u·ªëng", "ƒêi l·∫°i", "H·ªçc t·∫≠p", "Gi·∫£i tr√≠", "Mua s·∫Øm", "Kh√°c"]
CATEGORY_COLORS = {
    "ƒÇn u·ªëng": "#FFB6C1",
    "ƒêi l·∫°i": "#B0E0E6",
    "H·ªçc t·∫≠p": "#DDA0DD",
    "Gi·∫£i tr√≠": "#F0E68C",
    "Mua s·∫Øm": "#98D8C8",
    "Kh√°c": "#FFDAB9"
}

FONT_TITLE = ("Segoe UI", 20, "bold")
FONT_SUBTITLE = ("Segoe UI", 12, "bold")
FONT_NORMAL = ("Segoe UI", 11)
FONT_SMALL = ("Segoe UI", 9)

# Bi·∫øn to√†n c·ª•c l∆∞u UserID v√† username c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i
current_user_id = None
current_username = None
selected_category = None
editing_expense_id = None


# ======== H√ÄM TI·ªÜN √çCH ========
def format_currency(amount):
    """Format s·ªë ti·ªÅn v·ªõi d·∫•u ch·∫•m ph√¢n c√°ch, ch·ªâ l·∫•y ƒë·∫øn h√†ng ƒë∆°n v·ªã"""
    if amount is None:
        return "0"
    try:
        amount_int = int(float(amount))
        return f"{amount_int:,}".replace(",", ".")
    except:
        return "0"


def parse_currency(text):
    """Chuy·ªÉn ƒë·ªïi text c√≥ d·∫•u ch·∫•m v·ªÅ s·ªë"""
    if not text:
        return 0
    try:
        # Lo·∫°i b·ªè d·∫•u ch·∫•m ph√¢n c√°ch
        text = text.replace(".", "")
        return float(text)
    except:
        return 0


# ======== CH·ª®C NƒÇNG ƒêƒÇNG NH·∫¨P ========
def create_rounded_button(parent, text, command, bg_color, fg_color="white", width=200, height=50):
    btn = tk.Button(parent, text=text, command=command, bg=bg_color, fg=fg_color,
                    font=FONT_SUBTITLE, width=width, height=height,
                    relief=tk.FLAT, cursor="hand2", bd=0,
                    activebackground=bg_color, activeforeground=fg_color)
    return btn


def show_login():
    for widget in root.winfo_children():
        widget.destroy()

    root.title("ƒêƒÉng nh·∫≠p - Qu·∫£n l√Ω chi ti√™u c√° nh√¢n")
    root.geometry("500x400")
    root.resizable(False, False)
    root.configure(bg="#F5F5F5")

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    root.update_idletasks()
    x = (root.winfo_screenwidth() // 2) - (500 // 2)
    y = (root.winfo_screenheight() // 2) - (400 // 2)
    root.geometry(f"500x400+{x}+{y}")

    # Frame ch√≠nh
    frame_login = tk.Frame(root, bg="#F5F5F5")
    frame_login.pack(expand=True)

    tk.Label(frame_login, text="ƒêƒÇNG NH·∫¨P", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(20, 30))

    # T√™n ƒëƒÉng nh·∫≠p
    tk.Label(frame_login, text="T√™n ƒëƒÉng nh·∫≠p:", font=FONT_NORMAL, bg="#F5F5F5", fg="#555555").pack(anchor="w", padx=80,
                                                                                                    pady=(0, 5))
    entry_username = tk.Entry(frame_login, width=30, font=FONT_NORMAL, relief=tk.FLAT, bd=3,
                              highlightthickness=1, highlightbackground="#DDD", highlightcolor="#98D8C8")
    entry_username.pack(pady=(0, 15))
    entry_username.focus()

    # M·∫≠t kh·∫©u
    tk.Label(frame_login, text="M·∫≠t kh·∫©u:", font=FONT_NORMAL, bg="#F5F5F5", fg="#555555").pack(anchor="w", padx=80,
                                                                                               pady=(0, 5))

    # Frame cho m·∫≠t kh·∫©u v√† n√∫t hi·ªÉn th·ªã
    password_frame = tk.Frame(frame_login, bg="#F5F5F5")
    password_frame.pack(pady=(0, 20))

    entry_password = tk.Entry(password_frame, width=27, font=FONT_NORMAL, show="‚Ä¢", relief=tk.FLAT, bd=3,
                              highlightthickness=1, highlightbackground="#DDD", highlightcolor="#98D8C8")
    entry_password.pack(side=tk.LEFT, padx=(0, 5))

    # Bi·∫øn ƒë·ªÉ theo d√µi tr·∫°ng th√°i hi·ªÉn th·ªã m·∫≠t kh·∫©u
    password_visible = tk.BooleanVar(value=False)

    def toggle_password():
        if password_visible.get():
            # ·∫®n m·∫≠t kh·∫©u
            entry_password.config(show="‚Ä¢")
            btn_show_password.config(text="üëÅ")
        else:
            # Hi·ªÉn th·ªã m·∫≠t kh·∫©u
            entry_password.config(show="")
            btn_show_password.config(text="üôà")
        password_visible.set(not password_visible.get())

    # N√∫t hi·ªÉn th·ªã m·∫≠t kh·∫©u
    btn_show_password = tk.Button(password_frame, text="üëÅ", command=toggle_password,
                                  font=("Segoe UI", 11), bg="#E0E0E0", fg="#555555",
                                  relief=tk.FLAT, width=2, height=1,
                                  activebackground="#D0D0D0", activeforeground="#333333")
    btn_show_password.pack(side=tk.LEFT)

    # ====== H√ÄM X·ª¨ L√ù ======
    def login():
        global current_user_id, current_username
        username = entry_username.get().strip()
        password = entry_password.get().strip()

        if not username or not password:
            messagebox.showwarning("Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u!")
            return

        user_id = check_login(username, password)
        if user_id:
            current_user_id = user_id
            current_username = username
            messagebox.showinfo("Th√†nh c√¥ng", f"ƒêƒÉng nh·∫≠p th√†nh c√¥ng!\nXin ch√†o, {username}!")
            show_home_page()
        else:
            messagebox.showerror("L·ªói ƒëƒÉng nh·∫≠p", "T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!")

    def register():
        username = entry_username.get().strip()
        password = entry_password.get().strip()

        if not username or not password:
            messagebox.showwarning("Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n ƒëƒÉng nh·∫≠p v√† m·∫≠t kh·∫©u!")
            return
        if len(password) < 4:
            messagebox.showwarning("M·∫≠t kh·∫©u y·∫øu", "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±!")
            return

        if register_user(username, password):
            messagebox.showinfo("Th√†nh c√¥ng", "ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p.")
            entry_password.delete(0, tk.END)
        else:
            messagebox.showerror("L·ªói ƒëƒÉng k√Ω", "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i!")

    # ====== Hai n√∫t ƒëƒÉng nh·∫≠p & ƒëƒÉng k√Ω ======
    frame_buttons = tk.Frame(frame_login, bg="#F5F5F5")
    frame_buttons.pack(pady=15)

    def style_button(btn, bg, fg, border, hover_bg):
        btn.configure(
            bg=bg,
            fg=fg,
            font=("Segoe UI", 11, "bold"),
            relief="flat",
            bd=0,
            width=12,
            height=1,
            highlightthickness=1,
            highlightbackground=border,
            cursor="hand2",
            activebackground=hover_bg,
            activeforeground="#FFFFFF"
        )

    # T·∫°o n√∫t
    btn_login = tk.Button(frame_buttons, text="ƒêƒÉng nh·∫≠p", command=login)
    btn_register = tk.Button(frame_buttons, text="ƒêƒÉng k√Ω", command=register)

    # G√°n style
    style_button(btn_login, bg="#4FC3A1", fg="#FFFFFF", border="#3CA48A", hover_bg="#3CA48A")
    style_button(btn_register, bg="#D8B4E2", fg="#FFFFFF", border="#B685C5", hover_bg="#B685C5")

    # Hi·ªáu ·ª©ng bo g√≥c
    btn_login.configure(font=("Segoe UI", 11, "bold"), relief="flat")
    btn_register.configure(font=("Segoe UI", 11, "bold"), relief="flat")

    # ƒê·∫∑t ngang h√†ng
    btn_login.grid(row=0, column=0, padx=10)
    btn_register.grid(row=0, column=1, padx=10)



# ======== CH·ª®C NƒÇNG CH√çNH ========
def them_chi_tieu():
    global selected_category, editing_expense_id
    ngay_obj = entry_ngay.get_date()
    ngay = ngay_obj.strftime("%Y-%m-%d")
    danh_muc = selected_category
    so_tien_text = entry_sotien.get().strip()
    ghi_chu = entry_ghichu.get().strip()

    if not danh_muc or not so_tien_text:
        messagebox.showwarning("Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin (danh m·ª•c & s·ªë ti·ªÅn)!")
        return

    try:
        so_tien = parse_currency(so_tien_text)  # Parse s·ªë ti·ªÅn c√≥ d·∫•u ch·∫•m
    except ValueError:
        messagebox.showerror("L·ªói", "S·ªë ti·ªÅn ph·∫£i l√† s·ªë h·ª£p l·ªá!")
        return

    try:
        conn = get_connection()
        cursor = conn.cursor()

        if editing_expense_id:  # N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a
            # Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu tr∆∞·ªõc khi s·ª≠a
            cursor.execute("SELECT UserID FROM ChiTieu WHERE ID = %s", (editing_expense_id,))
            result = cursor.fetchone()
            if result and result[0] == current_user_id:
                cursor.execute("""
                    UPDATE ChiTieu 
                    SET Ngay = %s, Danh_muc = %s, So_tien = %s, Ghi_chu = %s 
                    WHERE ID = %s
                """, (ngay, danh_muc, so_tien, ghi_chu, editing_expense_id))
                conn.commit()
                messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t chi ti√™u!")
            else:
                messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ s·ª≠a chi ti√™u n√†y!")
        else:  # Th√™m m·ªõi
            cursor.execute("INSERT INTO ChiTieu (Ngay, Danh_muc, So_tien, Ghi_chu, UserID) VALUES (%s, %s, %s, %s, %s)",
                           (ngay, danh_muc, so_tien, ghi_chu, current_user_id))
            conn.commit()
            messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ th√™m chi ti√™u!")

        conn.close()

        # Reset form
        entry_sotien.delete(0, tk.END)
        entry_ghichu.delete(0, tk.END)
        selected_category = None
        editing_expense_id = None  # Reset bi·∫øn s·ª≠a

        # Reset m√†u n√∫t danh m·ª•c
        if 'category_buttons' in globals():
            for btn_text, btn in category_buttons.items():
                btn.configure(bg=CATEGORY_COLORS.get(btn_text, "#FFFFFF"), fg="#333333", relief=tk.RAISED)

        # ƒê√≥ng c·ª≠a s·ªï n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a
        if 'add_window' in globals() and editing_expense_id is None:
            add_window.destroy()

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi ghi v√†o c∆° s·ªü d·ªØ li·ªáu:\n{e}")

def hien_thi_du_lieu(ngay=None, thang=None, nam=None):
    """Hi·ªÉn th·ªã d·ªØ li·ªáu, c√≥ th·ªÉ l·ªçc theo ng√†y, th√°ng, nƒÉm - ch·ªâ hi·ªÉn th·ªã c·ªßa user hi·ªán t·∫°i"""
    for row in tree.get_children():
        tree.delete(row)

    try:
        conn = get_connection()
        cursor = conn.cursor()

        query = "SELECT ID, Ngay, Danh_muc, So_tien, Ghi_chu FROM ChiTieu WHERE UserID = %s"
        params = [current_user_id]

        if ngay:
            query += " AND Ngay = %s"
            params.append(ngay)
        elif thang and nam:
            query += " AND MONTH(Ngay) = %s AND YEAR(Ngay) = %s"
            params.extend([thang, nam])
        elif nam:
            query += " AND YEAR(Ngay) = %s"
            params.append(nam)

        query += " ORDER BY Ngay DESC, ID DESC"
        cursor.execute(query, tuple(params))
        rows = cursor.fetchall()
        conn.close()

        for r in rows:
            # Format s·ªë ti·ªÅn
            formatted_row = list(r)
            formatted_row[3] = format_currency(r[3])  # Format s·ªë ti·ªÅn ·ªü c·ªôt th·ª© 3
            tree.insert("", tk.END, values=formatted_row)

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi ƒë·ªçc d·ªØ li·ªáu:\n{e}")

def xoa_chi_tieu():
    selected = tree.selection()
    if not selected:
        messagebox.showwarning("Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn m·ªôt d√≤ng ƒë·ªÉ x√≥a.")
        return

    item = tree.item(selected[0])
    record_id = item['values'][0]

    if not messagebox.askyesno("X√°c nh·∫≠n", f"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi ti√™u ID = {record_id}?"):
        return

    try:
        conn = get_connection()
        cursor = conn.cursor()
        # Ki·ªÉm tra xem chi ti√™u c√≥ thu·ªôc v·ªÅ user hi·ªán t·∫°i kh√¥ng
        cursor.execute("SELECT UserID FROM ChiTieu WHERE ID = %s", (record_id,))
        result = cursor.fetchone()
        if result and result[0] == current_user_id:
            cursor.execute("DELETE FROM ChiTieu WHERE ID = %s", (record_id,))
            conn.commit()
            messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ x√≥a chi ti√™u.")
            hien_thi_du_lieu()
        else:
            messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ x√≥a chi ti√™u n√†y!")
        conn.close()
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu:\n{e}")


def sua_chi_tieu():
    """Ch·ª©c nƒÉng s·ª≠a chi ti√™u"""
    global editing_expense_id

    selected = tree.selection()
    if not selected:
        messagebox.showwarning("Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn m·ªôt d√≤ng ƒë·ªÉ s·ª≠a.")
        return

    item = tree.item(selected[0])
    record_id = item['values'][0]

    # Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT UserID FROM ChiTieu WHERE ID = %s", (record_id,))
        result = cursor.fetchone()
        conn.close()

        if not result or result[0] != current_user_id:
            messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ s·ª≠a chi ti√™u n√†y!")
            return
    except Exception as e:
        messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ ki·ªÉm tra quy·ªÅn s·ªü h·ªØu: {e}")
        return

    # L·∫•y th√¥ng tin chi ti√™u ƒë·ªÉ ƒëi·ªÅn v√†o form
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT Ngay, Danh_muc, So_tien, Ghi_chu FROM ChiTieu WHERE ID = %s", (record_id,))
        expense_data = cursor.fetchone()
        conn.close()

        if expense_data:
            editing_expense_id = record_id

            ngay_str = expense_data[0].strftime("%Y-%m-%d")  # Chuy·ªÉn datetime.date th√†nh string
            expense_data_processed = (ngay_str, expense_data[1], expense_data[2], expense_data[3])

            show_add_expense_window(expense_data_processed)  # Truy·ªÅn d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω v√†o form

    except Exception as e:
        messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ l·∫•y th√¥ng tin chi ti√™u: {e}")

def ve_bieu_do():
    """Hi·ªÉn th·ªã menu ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì"""
    choice_window = tk.Toplevel(root)
    choice_window.title("Ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì")
    choice_window.geometry("400x200")
    choice_window.transient(root)
    choice_window.grab_set()
    choice_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    choice_window.update_idletasks()
    x = (choice_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (choice_window.winfo_screenheight() // 2) - (200 // 2)
    choice_window.geometry(f"400x200+{x}+{y}")

    frame = tk.Frame(choice_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì:", font=("Arial", 12, "bold")).pack(pady=(0, 20))

    tk.Button(frame, text="Bi·ªÉu ƒë·ªì tr√≤n (T·ªïng theo danh m·ª•c)",
              command=lambda: [choice_window.destroy(), ve_bieu_do_tron()],
              width=40, height=2).pack(pady=5)

    tk.Button(frame, text="Bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng (Xu h∆∞·ªõng theo th√°ng)",
              command=lambda: [choice_window.destroy(), ve_bieu_do_xu_huong()],
              width=40, height=2).pack(pady=5)


def ve_bieu_do_tron():
    """Bi·ªÉu ƒë·ªì tr√≤n t·ªïng theo danh m·ª•c"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT Danh_muc, SUM(So_tien) FROM ChiTieu WHERE UserID = %s GROUP BY Danh_muc",
                       (current_user_id,))
        data = cursor.fetchall()
        conn.close()
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        return

    if not data:
        messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
        return

    danh_mucs = [row[0] if row[0] else "Kh√°c" for row in data]
    tong_tien = [float(row[1] or 0) for row in data]

    plt.figure(figsize=(6, 6))
    plt.pie(tong_tien, labels=danh_mucs, autopct='%1.1f%%')
    plt.title("Bi·ªÉu ƒë·ªì chi ti√™u theo danh m·ª•c")

    # TH√äM D√íNG N√ÄY: ƒê·∫£m b·∫£o c·ª≠a s·ªï matplotlib hi·ªÉn th·ªã tr√™n c√πng
    plt.gcf().canvas.manager.window.attributes('-topmost', 1)
    plt.gcf().canvas.manager.window.attributes('-topmost', 0)  # Reset sau khi focus
    plt.show()

def ve_bieu_do_xu_huong():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï ch·ªçn danh m·ª•c ƒë·ªÉ xem bi·ªÉu ƒë·ªì xu h∆∞·ªõng"""
    # L·∫•y danh s√°ch danh m·ª•c c√≥ d·ªØ li·ªáu
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT DISTINCT Danh_muc FROM ChiTieu WHERE UserID = %s ORDER BY Danh_muc",
                       (current_user_id,))
        categories = [row[0] if row[0] else "Kh√°c" for row in cursor.fetchall()]
        conn.close()

        if not categories:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu:\n{e}")
        return

    # T·∫°o c·ª≠a s·ªï ch·ªçn danh m·ª•c
    select_window = tk.Toplevel(root)
    select_window.title("Ch·ªçn danh m·ª•c xem xu h∆∞·ªõng")
    select_window.geometry("400x250")
    select_window.transient(root)
    select_window.grab_set()
    select_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    select_window.update_idletasks()
    x = (select_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (select_window.winfo_screenheight() // 2) - (250 // 2)
    select_window.geometry(f"400x250+{x}+{y}")

    frame = tk.Frame(select_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn danh m·ª•c:", font=("Arial", 12, "bold")).pack(pady=(0, 10))

    selected_category = tk.StringVar()
    selected_category.set(categories[0])

    combo_category = ttk.Combobox(frame, textvariable=selected_category, values=categories,
                                  state="readonly", width=30)
    combo_category.pack(pady=10)

    tk.Button(frame, text="Xem t·∫•t c·∫£ danh m·ª•c",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(None)],
              width=30, height=2).pack(pady=5)

    tk.Button(frame, text="Xem danh m·ª•c ƒë√£ ch·ªçn",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(selected_category.get())],
              width=30, height=2).pack(pady=5)


def ve_bieu_do_col_line(danh_muc=None):
    """V·∫Ω bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng th·ªÉ hi·ªán xu h∆∞·ªõng ti√™u d√πng theo th√°ng"""
    try:
        conn = get_connection()
        cursor = conn.cursor()

        if danh_muc:
            # L·∫•y d·ªØ li·ªáu theo th√°ng cho danh m·ª•c c·ª• th·ªÉ
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s AND Danh_muc = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay)
                ORDER BY YEAR(Ngay), MONTH(Ngay)
            """
            cursor.execute(query, (current_user_id, danh_muc))
            title = f"Xu h∆∞·ªõng chi ti√™u - {danh_muc}"
        else:
            # L·∫•y d·ªØ li·ªáu theo th√°ng cho t·∫•t c·∫£ danh m·ª•c
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, Danh_muc, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay), Danh_muc
                ORDER BY YEAR(Ngay), MONTH(Ngay), Danh_muc
            """
            cursor.execute(query, (current_user_id,))
            title = "Xu h∆∞·ªõng chi ti√™u - T·∫•t c·∫£ danh m·ª•c"

        data = cursor.fetchall()
        conn.close()

        if not data:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return

        # X·ª≠ l√Ω d·ªØ li·ªáu
        if danh_muc:
            # D·ªØ li·ªáu cho m·ªôt danh m·ª•c
            thang_nam = [f"{int(row[1]):02d}/{int(row[0])}" for row in data]
            tong_tien = [float(row[2]) for row in data]

            fig, ax = plt.subplots(figsize=(12, 6))

            # Bi·ªÉu ƒë·ªì c·ªôt
            bars = ax.bar(thang_nam, tong_tien, color='steelblue', alpha=0.7, label='Chi ti√™u')

            # Bi·ªÉu ƒë·ªì ƒë∆∞·ªùng
            ax.plot(thang_nam, tong_tien, color='red', marker='o', linewidth=2, markersize=8, label='Xu h∆∞·ªõng')

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.legend()
            ax.grid(True, alpha=0.3)

            # Xoay nh√£n tr·ª•c x ƒë·ªÉ d·ªÖ ƒë·ªçc
            plt.xticks(rotation=45, ha='right')

            # Th√™m gi√° tr·ªã tr√™n c·ªôt
            for bar in bars:
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width() / 2., height,
                        f'{height:,.0f}',
                        ha='center', va='bottom', fontsize=8)

            plt.tight_layout()

        else:
            # D·ªØ li·ªáu cho nhi·ªÅu danh m·ª•c
            # T·ªï ch·ª©c d·ªØ li·ªáu theo th√°ng/nƒÉm v√† danh m·ª•c
            data_dict = {}
            all_months = set()

            for row in data:
                nam, thang, danh_muc_item, tong_tien = row
                month_key = f"{int(thang):02d}/{int(nam)}"
                all_months.add(month_key)

                if danh_muc_item not in data_dict:
                    data_dict[danh_muc_item] = {}
                data_dict[danh_muc_item][month_key] = float(tong_tien)

            # S·∫Øp x·∫øp th√°ng (theo nƒÉm v√† th√°ng)
            def sort_key(month_str):
                parts = month_str.split('/')
                return (int(parts[1]), int(parts[0]))  # (nƒÉm, th√°ng)

            sorted_months = sorted(all_months, key=sort_key)

            # T·∫°o bi·ªÉu ƒë·ªì
            fig, ax = plt.subplots(figsize=(14, 7))

            # M√†u s·∫Øc cho c√°c danh m·ª•c
            colors = plt.cm.tab10(range(len(data_dict)))

            x = range(len(sorted_months))
            width = 0.8 / len(data_dict)  # ƒê·ªô r·ªông c·ªôt

            # V·∫Ω bi·ªÉu ƒë·ªì c·ªôt cho t·ª´ng danh m·ª•c (kh√¥ng hi·ªÉn th·ªã trong legend)
            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                offset = (idx - len(data_dict) / 2 + 0.5) * width
                bars = ax.bar([i + offset for i in x], values, width,
                              color=color, alpha=0.7)

            # V·∫Ω bi·ªÉu ƒë·ªì ƒë∆∞·ªùng cho t·ª´ng danh m·ª•c (xu h∆∞·ªõng c·ªßa t·ª´ng danh m·ª•c)
            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                ax.plot(x, values, color=color, marker='o', linewidth=2,
                        markersize=6, label=danh_muc_item,
                        linestyle='--', zorder=5, alpha=0.8)

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.set_xticks(x)
            ax.set_xticklabels(sorted_months, rotation=45, ha='right')
            ax.legend(loc='upper left')
            ax.grid(True, alpha=0.3)

            plt.tight_layout()

        # TH√äM ƒêO·∫†N CODE N√ÄY: ƒê·∫£m b·∫£o c·ª≠a s·ªï matplotlib hi·ªÉn th·ªã tr√™n c√πng
        plt.gcf().canvas.manager.window.attributes('-topmost', 1)
        plt.gcf().canvas.manager.window.attributes('-topmost', 0)  # Reset sau khi focus
        plt.show()

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        import traceback
        traceback.print_exc()

def select_category(category, category_buttons):
    """X·ª≠ l√Ω khi ch·ªçn danh m·ª•c chi ti√™u"""
    global selected_category
    selected_category = category  # L∆∞u l·∫°i danh m·ª•c ƒë√£ ch·ªçn

    # ƒê·∫∑t l·∫°i m√†u cho t·∫•t c·∫£ n√∫t
    for cat, btn in category_buttons.items():
        btn.configure(bg=CATEGORY_COLORS.get(cat, "#FFFFFF"), fg="#333333", relief=tk.RAISED)

    # T√¥ s√°ng n√∫t ƒë∆∞·ª£c ch·ªçn
    category_buttons[category].configure(bg="#4FC3A1", fg="white", relief=tk.SUNKEN)


def show_add_expense_window(expense_data=None):
    """Hi·ªÉn th·ªã c·ª≠a s·ªï th√™m/s·ª≠a chi ti√™u ri√™ng bi·ªát"""
    global entry_ngay, entry_sotien, entry_ghichu, selected_category, category_buttons, editing_expense_id, add_window

    add_window = tk.Toplevel(root)

    # Thi·∫øt l·∫≠p ti√™u ƒë·ªÅ d·ª±a tr√™n ch·∫ø ƒë·ªô
    if expense_data:
        add_window.title("S·ª≠a chi ti√™u")
        window_title = "‚úèÔ∏è S·ª¨A CHI TI√äU"
        button_text = "üíæ C·∫≠p nh·∫≠t chi ti√™u"
    else:
        add_window.title("Th√™m chi ti√™u")
        window_title = "‚ûï TH√äM CHI TI√äU"
        button_text = "‚ûï Th√™m chi ti√™u"
        editing_expense_id = None  # ƒê·∫£m b·∫£o l√† ch·∫ø ƒë·ªô th√™m m·ªõi

    add_window.geometry("600x700")
    add_window.configure(bg="#F8F9FA")
    add_window.transient(root)
    add_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    add_window.update_idletasks()
    x = (add_window.winfo_screenwidth() // 2) - (600 // 2)
    y = (add_window.winfo_screenheight() // 2) - (700 // 2)
    add_window.geometry(f"600x700+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(add_window, text=window_title, font=FONT_TITLE, bg="#F8F9FA", fg="#333333").pack(pady=(20, 30))

    # Frame ch√≠nh
    main_frame = tk.Frame(add_window, bg="#F8F9FA")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=10)

    # ==== CH·ªåN NG√ÄY ====
    date_frame = tk.LabelFrame(main_frame, text="üìÖ Ch·ªçn ng√†y", font=FONT_SUBTITLE,
                               bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    date_frame.pack(fill=tk.X, pady=(0, 15))
    entry_ngay = DateEntry(date_frame, date_pattern='yyyy-mm-dd', font=FONT_NORMAL, width=20)
    entry_ngay.pack(pady=5)

    # ==== CH·ªåN DANH M·ª§C ====
    category_frame = tk.LabelFrame(main_frame, text="üóÇÔ∏è Ch·ªçn danh m·ª•c", font=FONT_SUBTITLE,
                                   bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    category_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 15))

    btn_container = tk.Frame(category_frame, bg="#FFFFFF")
    btn_container.pack(fill=tk.BOTH, expand=True, pady=10)

    category_buttons = {}
    total_cols = 3
    for i, category in enumerate(CATEGORIES):
        btn = tk.Button(
            btn_container,
            text=category,
            font=FONT_NORMAL,
            bg=CATEGORY_COLORS.get(category, "#FFFFFF"),
            fg="#333333",
            relief=tk.RAISED,
            bd=1,
            padx=20,
            pady=10,
            cursor="hand2",
            activebackground="#333333",
            activeforeground="#FFFFFF",
            command=lambda c=category: select_category(c, category_buttons)
        )
        btn.grid(row=i // total_cols, column=i % total_cols, padx=10, pady=10, sticky="nsew")
        category_buttons[category] = btn

    for j in range(total_cols):
        btn_container.columnconfigure(j, weight=1)

    # ==== S·ªê TI·ªÄN ====
    amount_frame = tk.LabelFrame(main_frame, text="üí∞ Nh·∫≠p s·ªë ti·ªÅn", font=FONT_SUBTITLE,
                                 bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    amount_frame.pack(fill=tk.X, pady=(0, 15))

    entry_sotien = tk.Entry(amount_frame, font=FONT_NORMAL, justify="right")
    entry_sotien.pack(fill=tk.X, padx=10, pady=5)

    def on_amount_change(event):
        raw = entry_sotien.get().replace(".", "")
        if not raw:
            return
        if raw.isdigit():
            caret = entry_sotien.index(tk.INSERT)
            formatted = format_currency(raw)
            entry_sotien.delete(0, tk.END)
            entry_sotien.insert(0, formatted)
            entry_sotien.icursor(min(caret, len(formatted)))

    entry_sotien.bind("<KeyRelease>", on_amount_change)

    # ==== GHI CH√ö ====
    note_frame = tk.LabelFrame(main_frame, text="üìù Ghi ch√∫", font=FONT_SUBTITLE,
                               bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    note_frame.pack(fill=tk.X, pady=(0, 15))

    entry_ghichu = tk.Entry(note_frame, font=FONT_NORMAL)
    entry_ghichu.pack(fill=tk.X, padx=10, pady=5)

    # ==== N√öT CH√çNH ====
    btn_add = tk.Button(
        main_frame,
        text=button_text,
        command=lambda: [them_chi_tieu(), add_window.destroy() if not editing_expense_id else None],
        bg="#4FC3A1",
        fg="white",
        font=FONT_SUBTITLE,
        relief=tk.FLAT,
        cursor="hand2",
        padx=15,
        pady=10
    )
    btn_add.pack(pady=20, ipadx=10)

    # ==== ƒêI·ªÄN D·ªÆ LI·ªÜU N·∫æU ƒêANG S·ª¨A ====
    if expense_data:
        ngay, danh_muc, so_tien, ghi_chu = expense_data

        # ƒêi·ªÅn ng√†y
        entry_ngay.set_date(datetime.strptime(ngay, "%Y-%m-%d"))

        # ƒêi·ªÅn danh m·ª•c
        if danh_muc in category_buttons:
            select_category(danh_muc, category_buttons)

        # ƒêi·ªÅn s·ªë ti·ªÅn
        entry_sotien.delete(0, tk.END)
        entry_sotien.insert(0, format_currency(so_tien))

        # ƒêi·ªÅn ghi ch√∫
        entry_ghichu.delete(0, tk.END)
        if ghi_chu:
            entry_ghichu.insert(0, ghi_chu)


def show_view_expense_window():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï xem chi ti√™u ri√™ng bi·ªát"""
    global tree, filter_ngay, filter_thang, filter_nam

    view_window = tk.Toplevel(root)
    view_window.title("Xem chi ti√™u")
    view_window.geometry("1000x600")
    view_window.configure(bg="#F5F5F5")
    view_window.transient(root)
    view_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    view_window.update_idletasks()
    x = (view_window.winfo_screenwidth() // 2) - (1000 // 2)
    y = (view_window.winfo_screenheight() // 2) - (600 // 2)
    view_window.geometry(f"1000x600+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(view_window, text="üìä XEM CHI TI√äU", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(20, 20))

    # Frame ch√≠nh
    main_frame = tk.Frame(view_window, bg="#F5F5F5")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

    # Frame l·ªçc
    frame_filter = tk.LabelFrame(main_frame, text="L·ªçc d·ªØ li·ªáu", font=FONT_SUBTITLE, bg="#FFFFFF",
                                 fg="#333333", padx=15, pady=10)
    frame_filter.pack(fill=tk.X, pady=(0, 15))

    tk.Label(frame_filter, text="Ng√†y:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=0, padx=5)
    filter_ngay = DateEntry(frame_filter, date_pattern='yyyy-mm-dd', font=FONT_SMALL)
    filter_ngay.grid(row=0, column=1, padx=5)
    tk.Button(frame_filter, text="L·ªçc theo ng√†y",
              command=lambda: hien_thi_du_lieu(filter_ngay.get_date().strftime("%Y-%m-%d")),
              font=FONT_SMALL, bg="#B0E0E6", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=2, padx=5)

    tk.Label(frame_filter, text="Th√°ng:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=3, padx=5)
    filter_thang = ttk.Combobox(frame_filter, values=list(range(1, 13)), width=5, state="readonly",
                                font=FONT_SMALL)
    filter_thang.grid(row=0, column=4)
    filter_thang.set(datetime.now().month)

    tk.Label(frame_filter, text="NƒÉm:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=5, padx=5)
    filter_nam = ttk.Combobox(frame_filter, values=list(range(2020, datetime.now().year + 1)), width=7,
                              state="readonly", font=FONT_SMALL)
    filter_nam.grid(row=0, column=6)
    filter_nam.set(datetime.now().year)

    tk.Button(frame_filter, text="L·ªçc theo th√°ng",
              command=lambda: hien_thi_du_lieu(None, int(filter_thang.get()), int(filter_nam.get())),
              font=FONT_SMALL, bg="#DDA0DD", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=7, padx=5)
    tk.Button(frame_filter, text="L·ªçc theo nƒÉm",
              command=lambda: hien_thi_du_lieu(None, None, int(filter_nam.get())),
              font=FONT_SMALL, bg="#F0E68C", fg="#333333", relief=tk.FLAT).grid(row=0, column=8, padx=5)
    tk.Button(frame_filter, text="Hi·ªÉn th·ªã t·∫•t c·∫£", command=hien_thi_du_lieu,
              font=FONT_SMALL, bg="#98D8C8", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=9, padx=5)

    # B·∫£ng hi·ªÉn th·ªã
    frame_table = tk.Frame(main_frame, bg="#FFFFFF")
    frame_table.pack(fill=tk.BOTH, expand=True, pady=(0, 10))

    tree = ttk.Treeview(frame_table, columns=("ID", "Ng√†y", "Danh m·ª•c", "S·ªë ti·ªÅn", "Ghi ch√∫"), show="headings")
    tree.heading("ID", text="ID")
    tree.heading("Ng√†y", text="Ng√†y")
    tree.heading("Danh m·ª•c", text="Danh m·ª•c")
    tree.heading("S·ªë ti·ªÅn", text="S·ªë ti·ªÅn")
    tree.heading("Ghi ch√∫", text="Ghi ch√∫")
    tree.column("ID", width=50, anchor="center")
    tree.column("Ng√†y", width=120, anchor="center")
    tree.column("Danh m·ª•c", width=120)
    tree.column("S·ªë ti·ªÅn", width=150, anchor="e")
    tree.column("Ghi ch√∫", width=300)
    tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

    scrollbar = ttk.Scrollbar(frame_table, orient=tk.VERTICAL, command=tree.yview)
    tree.configure(yscrollcommand=scrollbar.set)
    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

    # N√∫t ch·ª©c nƒÉng
    btn_frame = tk.Frame(main_frame, bg="#F5F5F5")
    btn_frame.pack(fill=tk.X)

    # Frame ch·ª©a 2 n√∫t
    button_container = tk.Frame(btn_frame, bg="#F5F5F5")
    button_container.pack(pady=10)

    # N√∫t s·ª≠a
    btn_edit = tk.Button(button_container, text="‚úèÔ∏è S·ª≠a chi ti√™u ƒë√£ ch·ªçn", command=sua_chi_tieu,
                         font=FONT_SUBTITLE, bg="#4FC3A1", fg="#FFFFFF", relief=tk.FLAT, padx=20, pady=10)
    btn_edit.pack(side=tk.LEFT, padx=10)

    # N√∫t x√≥a
    btn_delete = tk.Button(button_container, text="üóëÔ∏è X√≥a chi ti√™u ƒë√£ ch·ªçn", command=xoa_chi_tieu,
                           font=FONT_SUBTITLE, bg="#FFB6C1", fg="#FFFFFF", relief=tk.FLAT, padx=20, pady=10)
    btn_delete.pack(side=tk.LEFT, padx=10)

    # Hi·ªÉn th·ªã d·ªØ li·ªáu ban ƒë·∫ßu
    hien_thi_du_lieu()

def show_chart_window():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï bi·ªÉu ƒë·ªì ri√™ng bi·ªát"""
    chart_window = tk.Toplevel(root)
    chart_window.title("Bi·ªÉu ƒë·ªì chi ti√™u")
    chart_window.geometry("500x400")
    chart_window.configure(bg="#F5F5F5")
    chart_window.transient(root)
    chart_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    chart_window.update_idletasks()
    x = (chart_window.winfo_screenwidth() // 2) - (500 // 2)
    y = (chart_window.winfo_screenheight() // 2) - (400 // 2)
    chart_window.geometry(f"500x400+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(chart_window, text="üìà BI·ªÇU ƒê·ªí CHI TI√äU", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(30, 30))

    # Frame ch√≠nh
    main_frame = tk.Frame(chart_window, bg="#F5F5F5")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=50, pady=20)

    btn_frame = tk.Frame(main_frame, bg="#F5F5F5")
    btn_frame.pack()

    btn1 = create_rounded_button(btn_frame, "üìä Bi·ªÉu ƒë·ªì tr√≤n", ve_bieu_do_tron, "#FFB6C1", "#FFFFFF", 25, 2)
    btn1.pack(pady=10, fill=tk.X)

    btn2 = create_rounded_button(btn_frame, "üìà Bi·ªÉu ƒë·ªì xu h∆∞·ªõng", ve_bieu_do_xu_huong, "#DDA0DD", "#FFFFFF", 25, 2)
    btn2.pack(pady=10, fill=tk.X)

def get_total_expenses():
    """L·∫•y t·ªïng chi ti√™u c·ªßa user hi·ªán t·∫°i"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT SUM(So_tien) FROM ChiTieu WHERE UserID = %s", (current_user_id,))
        result = cursor.fetchone()
        conn.close()
        return float(result[0] or 0)
    except:
        return 0

def get_expense_count():
    """L·∫•y s·ªë l∆∞·ª£ng chi ti√™u"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM ChiTieu WHERE UserID = %s", (current_user_id,))
        result = cursor.fetchone()
        conn.close()
        return result[0] or 0
    except:
        return 0

def get_monthly_expense():
    """L·∫•y chi ti√™u th√°ng hi·ªán t·∫°i"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        current_month = datetime.now().month
        current_year = datetime.now().year
        cursor.execute("SELECT SUM(So_tien) FROM ChiTieu WHERE UserID = %s AND MONTH(Ngay) = %s AND YEAR(Ngay) = %s",
                       (current_user_id, current_month, current_year))
        result = cursor.fetchone()
        conn.close()
        return float(result[0] or 0)
    except:
        return 0
