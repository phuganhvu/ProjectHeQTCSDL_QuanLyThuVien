
def ve_bieu_do():
    """Hi·ªÉn th·ªã menu ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì"""
    choice_window = tk.Toplevel(root)
    choice_window.title("Ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì")
    choice_window.geometry("400x200")
    choice_window.transient(root)
    choice_window.grab_set()
    choice_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    choice_window.update_idletasks()
    x = (choice_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (choice_window.winfo_screenheight() // 2) - (200 // 2)
    choice_window.geometry(f"400x200+{x}+{y}")

    frame = tk.Frame(choice_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn lo·∫°i bi·ªÉu ƒë·ªì:", font=("Arial", 12, "bold")).pack(pady=(0, 20))

    tk.Button(frame, text="Bi·ªÉu ƒë·ªì tr√≤n (T·ªïng theo danh m·ª•c)",
              command=lambda: [choice_window.destroy(), ve_bieu_do_tron()],
              width=40, height=2).pack(pady=5)

    tk.Button(frame, text="Bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng (Xu h∆∞·ªõng theo th√°ng)",
              command=lambda: [choice_window.destroy(), ve_bieu_do_xu_huong()],
              width=40, height=2).pack(pady=5)


def ve_bieu_do_tron():
    """Bi·ªÉu ƒë·ªì tr√≤n t·ªïng theo danh m·ª•c"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT Danh_muc, SUM(So_tien) FROM ChiTieu WHERE UserID = %s GROUP BY Danh_muc",
                       (current_user_id,))
        data = cursor.fetchall()
        conn.close()
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")
        return

    if not data:
        messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
        return

    danh_mucs = [row[0] if row[0] else "Kh√°c" for row in data]
    tong_tien = [float(row[1] or 0) for row in data]

    plt.figure(figsize=(6, 6))
    plt.pie(tong_tien, labels=danh_mucs, autopct='%1.1f%%')
    plt.title("Bi·ªÉu ƒë·ªì chi ti√™u theo danh m·ª•c")

    plt.gcf().canvas.manager.window.attributes('-topmost', 1)
    plt.gcf().canvas.manager.window.attributes('-topmost', 0)
    plt.show()

def ve_bieu_do_xu_huong():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï ch·ªçn danh m·ª•c ƒë·ªÉ xem bi·ªÉu ƒë·ªì xu h∆∞·ªõng"""
    # L·∫•y danh s√°ch danh m·ª•c c√≥ d·ªØ li·ªáu
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT DISTINCT Danh_muc FROM ChiTieu WHERE UserID = %s ORDER BY Danh_muc",
                       (current_user_id,))
        categories = [row[0] if row[0] else "Kh√°c" for row in cursor.fetchall()]
        conn.close()

        if not categories:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu:\n{e}")
        return

    # T·∫°o c·ª≠a s·ªï ch·ªçn danh m·ª•c
    select_window = tk.Toplevel(root)
    select_window.title("Ch·ªçn danh m·ª•c xem xu h∆∞·ªõng")
    select_window.geometry("400x250")
    select_window.transient(root)
    select_window.grab_set()
    select_window.resizable(False, False)

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    select_window.update_idletasks()
    x = (select_window.winfo_screenwidth() // 2) - (400 // 2)
    y = (select_window.winfo_screenheight() // 2) - (250 // 2)
    select_window.geometry(f"400x250+{x}+{y}")

    frame = tk.Frame(select_window, padx=20, pady=20)
    frame.pack(fill=tk.BOTH, expand=True)

    tk.Label(frame, text="Ch·ªçn danh m·ª•c:", font=("Arial", 12, "bold")).pack(pady=(0, 10))

    selected_category = tk.StringVar()
    selected_category.set(categories[0])

    combo_category = ttk.Combobox(frame, textvariable=selected_category, values=categories,
                                  state="readonly", width=30)
    combo_category.pack(pady=10)

    tk.Button(frame, text="Xem t·∫•t c·∫£ danh m·ª•c",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(None)],
              width=30, height=2).pack(pady=5)

    tk.Button(frame, text="Xem danh m·ª•c ƒë√£ ch·ªçn",
              command=lambda: [select_window.destroy(), ve_bieu_do_col_line(selected_category.get())],
              width=30, height=2).pack(pady=5)


def ve_bieu_do_col_line(danh_muc=None):
    """V·∫Ω bi·ªÉu ƒë·ªì c·ªôt v√† ƒë∆∞·ªùng th·ªÉ hi·ªán xu h∆∞·ªõng ti√™u d√πng theo th√°ng"""
    try:
        conn = get_connection()
        cursor = conn.cursor()

        if danh_muc:
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s AND Danh_muc = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay)
                ORDER BY YEAR(Ngay), MONTH(Ngay)
            """
            cursor.execute(query, (current_user_id, danh_muc))
            title = f"Xu h∆∞·ªõng chi ti√™u - {danh_muc}"
        else:
            query = """
                SELECT YEAR(Ngay) as Nam, MONTH(Ngay) as Thang, Danh_muc, SUM(So_tien) as Tong_tien
                FROM ChiTieu 
                WHERE UserID = %s
                GROUP BY YEAR(Ngay), MONTH(Ngay), Danh_muc
                ORDER BY YEAR(Ngay), MONTH(Ngay), Danh_muc
            """
            cursor.execute(query, (current_user_id,))
            title = "Xu h∆∞·ªõng chi ti√™u - T·∫•t c·∫£ danh m·ª•c"

        data = cursor.fetchall()
        conn.close()

        if not data:
            messagebox.showinfo("Th√¥ng b√°o", "Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì.")
            return

        # T·∫°o c·ª≠a s·ªï Tkinter m·ªõi cho bi·ªÉu ƒë·ªì
        chart_window = tk.Toplevel(root)
        chart_window.title(title)
        chart_window.geometry("900x700")
        chart_window.transient(root)
        chart_window.grab_set()

        # ƒê·∫£m b·∫£o c·ª≠a s·ªï hi·ªÉn th·ªã tr√™n c√πng
        chart_window.attributes('-topmost', 1)
        chart_window.focus_force()

        # T·∫°o frame ch·ª©a bi·ªÉu ƒë·ªì
        frame = tk.Frame(chart_window)
        frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # T·∫°o Figure v√† ƒë∆∞a v√†o Tkinter
        from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk

        if danh_muc:
            fig, ax = plt.subplots(figsize=(10, 6))

            # X·ª≠ l√Ω d·ªØ li·ªáu
            thang_nam = [f"{int(row[1]):02d}/{int(row[0])}" for row in data]
            tong_tien = [float(row[2]) for row in data]

            # Bi·ªÉu ƒë·ªì c·ªôt
            bars = ax.bar(thang_nam, tong_tien, color='steelblue', alpha=0.7, label='Chi ti√™u')
            ax.plot(thang_nam, tong_tien, color='red', marker='o', linewidth=2, markersize=8, label='Xu h∆∞·ªõng')
            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.legend()
            ax.grid(True, alpha=0.3)
            plt.xticks(rotation=45, ha='right')

            # Th√™m gi√° tr·ªã tr√™n c·ªôt
            for bar in bars:
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width() / 2., height,
                        f'{height:,.0f}',
                        ha='center', va='bottom', fontsize=8)

        else:
            fig, ax = plt.subplots(figsize=(12, 7))

            # X·ª≠ l√Ω d·ªØ li·ªáu nhi·ªÅu danh m·ª•c
            data_dict = {}
            all_months = set()

            for row in data:
                nam, thang, danh_muc_item, tong_tien = row
                month_key = f"{int(thang):02d}/{int(nam)}"
                all_months.add(month_key)

                if danh_muc_item not in data_dict:
                    data_dict[danh_muc_item] = {}
                data_dict[danh_muc_item][month_key] = float(tong_tien)

            # S·∫Øp x·∫øp th√°ng
            def sort_key(month_str):
                parts = month_str.split('/')
                return (int(parts[1]), int(parts[0]))

            sorted_months = sorted(all_months, key=sort_key)

            # V·∫Ω bi·ªÉu ƒë·ªì
            colors = plt.cm.tab10(range(len(data_dict)))
            x = range(len(sorted_months))
            width = 0.8 / len(data_dict)

            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                offset = (idx - len(data_dict) / 2 + 0.5) * width
                ax.bar([i + offset for i in x], values, width, color=color, alpha=0.7)

            for idx, (danh_muc_item, color) in enumerate(zip(data_dict.keys(), colors)):
                values = [data_dict[danh_muc_item].get(month, 0) for month in sorted_months]
                ax.plot(x, values, color=color, marker='o', linewidth=2,
                        markersize=6, label=danh_muc_item, linestyle='--')

            ax.set_xlabel('Th√°ng/NƒÉm', fontsize=10)
            ax.set_ylabel('S·ªë ti·ªÅn (VNƒê)', fontsize=10)
            ax.set_title(title, fontsize=14, fontweight='bold')
            ax.set_xticks(x)
            ax.set_xticklabels(sorted_months, rotation=45, ha='right')
            ax.legend(loc='upper left')
            ax.grid(True, alpha=0.3)

        plt.tight_layout()

        # Embed v√†o Tkinter
        canvas = FigureCanvasTkAgg(fig, master=frame)
        canvas.draw()
        canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        # Th√™m toolbar (c√≥ n√∫t ƒë√≥ng tr√™n toolbar r·ªìi)
        toolbar = NavigationToolbar2Tk(canvas, frame)
        toolbar.update()
        canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)

        # Reset topmost sau khi hi·ªÉn th·ªã
        chart_window.attributes('-topmost', 0)

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi l·∫•y d·ªØ li·ªáu bi·ªÉu ƒë·ªì:\n{e}")





def show_view_expense_window():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï xem chi ti√™u ri√™ng bi·ªát"""
    global tree, filter_ngay, filter_thang, filter_nam

    view_window = tk.Toplevel(root)
    view_window.title("Xem chi ti√™u")
    view_window.geometry("1000x600")
    view_window.configure(bg="#F5F5F5")
    view_window.transient(root)
    view_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    view_window.update_idletasks()
    x = (view_window.winfo_screenwidth() // 2) - (1000 // 2)
    y = (view_window.winfo_screenheight() // 2) - (600 // 2)
    view_window.geometry(f"1000x600+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(view_window, text="üìä XEM CHI TI√äU", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(20, 20))

    # Frame ch√≠nh
    main_frame = tk.Frame(view_window, bg="#F5F5F5")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

    # Frame l·ªçc
    frame_filter = tk.LabelFrame(main_frame, text="L·ªçc d·ªØ li·ªáu", font=FONT_SUBTITLE, bg="#FFFFFF",
                                 fg="#333333", padx=15, pady=10)
    frame_filter.pack(fill=tk.X, pady=(0, 15))

    tk.Label(frame_filter, text="Ng√†y:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=0, padx=5)
    filter_ngay = DateEntry(frame_filter, date_pattern='yyyy-mm-dd', font=FONT_SMALL)
    filter_ngay.grid(row=0, column=1, padx=5)
    tk.Button(frame_filter, text="L·ªçc theo ng√†y",
              command=lambda: hien_thi_du_lieu(filter_ngay.get_date().strftime("%Y-%m-%d")),
              font=FONT_SMALL, bg="#B0E0E6", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=2, padx=5)

    tk.Label(frame_filter, text="Th√°ng:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=3, padx=5)
    filter_thang = ttk.Combobox(frame_filter, values=list(range(1, 13)), width=5, state="readonly",
                                font=FONT_SMALL)
    filter_thang.grid(row=0, column=4)
    filter_thang.set(datetime.now().month)

    tk.Label(frame_filter, text="NƒÉm:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=5, padx=5)
    filter_nam = ttk.Combobox(frame_filter, values=list(range(2020, datetime.now().year + 1)), width=7,
                              state="readonly", font=FONT_SMALL)
    filter_nam.grid(row=0, column=6)
    filter_nam.set(datetime.now().year)

    tk.Button(frame_filter, text="L·ªçc theo th√°ng",
              command=lambda: hien_thi_du_lieu(None, int(filter_thang.get()), int(filter_nam.get())),
              font=FONT_SMALL, bg="#DDA0DD", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=7, padx=5)
    tk.Button(frame_filter, text="L·ªçc theo nƒÉm",
              command=lambda: hien_thi_du_lieu(None, None, int(filter_nam.get())),
              font=FONT_SMALL, bg="#F0E68C", fg="#333333", relief=tk.FLAT).grid(row=0, column=8, padx=5)
    tk.Button(frame_filter, text="Hi·ªÉn th·ªã t·∫•t c·∫£", command=hien_thi_du_lieu,
              font=FONT_SMALL, bg="#98D8C8", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=9, padx=5)

    # B·∫£ng hi·ªÉn th·ªã
    frame_table = tk.Frame(main_frame, bg="#FFFFFF")
    frame_table.pack(fill=tk.BOTH, expand=True, pady=(0, 10))

    tree = ttk.Treeview(frame_table, columns=("ID", "Ng√†y", "Danh m·ª•c", "S·ªë ti·ªÅn", "Ghi ch√∫"), show="headings")
    tree.heading("ID", text="ID")
    tree.heading("Ng√†y", text="Ng√†y")
    tree.heading("Danh m·ª•c", text="Danh m·ª•c")
    tree.heading("S·ªë ti·ªÅn", text="S·ªë ti·ªÅn")
    tree.heading("Ghi ch√∫", text="Ghi ch√∫")
    tree.column("ID", width=50, anchor="center")
    tree.column("Ng√†y", width=120, anchor="center")
    tree.column("Danh m·ª•c", width=120)
    tree.column("S·ªë ti·ªÅn", width=150, anchor="e")
    tree.column("Ghi ch√∫", width=300)
    tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

    scrollbar = ttk.Scrollbar(frame_table, orient=tk.VERTICAL, command=tree.yview)
    tree.configure(yscrollcommand=scrollbar.set)
    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

    # N√∫t ch·ª©c nƒÉng
    btn_frame = tk.Frame(main_frame, bg="#F5F5F5")
    btn_frame.pack(fill=tk.X)

    # Frame ch·ª©a 2 n√∫t
    button_container = tk.Frame(btn_frame, bg="#F5F5F5")
    button_container.pack(pady=10)

    # N√∫t s·ª≠a
    btn_edit = tk.Button(button_container, text="‚úèÔ∏è S·ª≠a chi ti√™u ƒë√£ ch·ªçn", command=sua_chi_tieu,
                         font=FONT_SUBTITLE, bg="#4FC3A1", fg="#FFFFFF", relief=tk.FLAT, padx=20, pady=10)
    btn_edit.pack(side=tk.LEFT, padx=10)

    # N√∫t x√≥a
    btn_delete = tk.Button(button_container, text="üóëÔ∏è X√≥a chi ti√™u ƒë√£ ch·ªçn", command=xoa_chi_tieu,
                           font=FONT_SUBTITLE, bg="#FFB6C1", fg="#FFFFFF", relief=tk.FLAT, padx=20, pady=10)
    btn_delete.pack(side=tk.LEFT, padx=10)

    # Hi·ªÉn th·ªã d·ªØ li·ªáu ban ƒë·∫ßu
    hien_thi_du_lieu()

def show_chart_window():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï bi·ªÉu ƒë·ªì ri√™ng bi·ªát"""
    chart_window = tk.Toplevel(root)
    chart_window.title("Bi·ªÉu ƒë·ªì chi ti√™u")
    chart_window.geometry("500x400")
    chart_window.configure(bg="#F5F5F5")
    chart_window.transient(root)
    chart_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    chart_window.update_idletasks()
    x = (chart_window.winfo_screenwidth() // 2) - (500 // 2)
    y = (chart_window.winfo_screenheight() // 2) - (400 // 2)
    chart_window.geometry(f"500x400+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(chart_window, text="üìà BI·ªÇU ƒê·ªí CHI TI√äU", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(30, 30))

    # Frame ch√≠nh
    main_frame = tk.Frame(chart_window, bg="#F5F5F5")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=50, pady=20)

    btn_frame = tk.Frame(main_frame, bg="#F5F5F5")
    btn_frame.pack()

    btn1 = create_rounded_button(btn_frame, "üìä Bi·ªÉu ƒë·ªì tr√≤n", ve_bieu_do_tron, "#FFB6C1", "#FFFFFF", 25, 2)
    btn1.pack(pady=10, fill=tk.X)

    btn2 = create_rounded_button(btn_frame, "üìà Bi·ªÉu ƒë·ªì xu h∆∞·ªõng", ve_bieu_do_xu_huong, "#DDA0DD", "#FFFFFF", 25, 2)
    btn2.pack(pady=10, fill=tk.X)
def get_total_expenses():
    """L·∫•y t·ªïng chi ti√™u c·ªßa user hi·ªán t·∫°i"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT SUM(So_tien) FROM ChiTieu WHERE UserID = %s", (current_user_id,))
        result = cursor.fetchone()
        conn.close()
        return float(result[0] or 0)
    except:
        return 0

def get_expense_count():
    """L·∫•y s·ªë l∆∞·ª£ng chi ti√™u"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM ChiTieu WHERE UserID = %s", (current_user_id,))
        result = cursor.fetchone()
        conn.close()
        return result[0] or 0
    except:
        return 0

def get_monthly_expense():
    """L·∫•y chi ti√™u th√°ng hi·ªán t·∫°i"""
    try:
        conn = get_connection()
        cursor = conn.cursor()
        current_month = datetime.now().month
        current_year = datetime.now().year
        cursor.execute("SELECT SUM(So_tien) FROM ChiTieu WHERE UserID = %s AND MONTH(Ngay) = %s AND YEAR(Ngay) = %s",
                       (current_user_id, current_month, current_year))
        result = cursor.fetchone()
        conn.close()
        return float(result[0] or 0)
    except:
        return 0
