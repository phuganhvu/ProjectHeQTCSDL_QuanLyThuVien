
# ======== CH·ª®C NƒÇNG CH√çNH ========
def them_chi_tieu():
    global selected_category, editing_expense_id
    ngay_obj = entry_ngay.get_date()
    ngay = ngay_obj.strftime("%Y-%m-%d")
    danh_muc = selected_category
    so_tien_text = entry_sotien.get().strip()
    ghi_chu = entry_ghichu.get().strip()

    if not danh_muc or not so_tien_text:
        messagebox.showwarning("Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin (danh m·ª•c & s·ªë ti·ªÅn)!")
        return

    try:
        so_tien = parse_currency(so_tien_text)  # Parse s·ªë ti·ªÅn c√≥ d·∫•u ch·∫•m
    except ValueError:
        messagebox.showerror("L·ªói", "S·ªë ti·ªÅn ph·∫£i l√† s·ªë h·ª£p l·ªá!")
        return

    try:
        conn = get_connection()
        cursor = conn.cursor()

        if editing_expense_id:  # N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a
            # Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu tr∆∞·ªõc khi s·ª≠a
            cursor.execute("SELECT UserID FROM ChiTieu WHERE ID = %s", (editing_expense_id,))
            result = cursor.fetchone()
            if result and result[0] == current_user_id:
                cursor.execute("""
                    UPDATE ChiTieu 
                    SET Ngay = %s, Danh_muc = %s, So_tien = %s, Ghi_chu = %s 
                    WHERE ID = %s
                """, (ngay, danh_muc, so_tien, ghi_chu, editing_expense_id))
                conn.commit()
                messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ c·∫≠p nh·∫≠t chi ti√™u!")
            else:
                messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ s·ª≠a chi ti√™u n√†y!")
        else:  # Th√™m m·ªõi
            cursor.execute("INSERT INTO ChiTieu (Ngay, Danh_muc, So_tien, Ghi_chu, UserID) VALUES (%s, %s, %s, %s, %s)",
                           (ngay, danh_muc, so_tien, ghi_chu, current_user_id))
            conn.commit()
            messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ th√™m chi ti√™u!")

        conn.close()

        # Reset form
        entry_sotien.delete(0, tk.END)
        entry_ghichu.delete(0, tk.END)
        selected_category = None
        editing_expense_id = None  # Reset bi·∫øn s·ª≠a

        # Reset m√†u n√∫t danh m·ª•c
        if 'category_buttons' in globals():
            for btn_text, btn in category_buttons.items():
                btn.configure(bg=CATEGORY_COLORS.get(btn_text, "#FFFFFF"), fg="#333333", relief=tk.RAISED)

        # ƒê√≥ng c·ª≠a s·ªï n·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a
        if 'add_window' in globals() and editing_expense_id is None:
            add_window.destroy()

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi ghi v√†o c∆° s·ªü d·ªØ li·ªáu:\n{e}")

def hien_thi_du_lieu(ngay=None, thang=None, nam=None):
    """Hi·ªÉn th·ªã d·ªØ li·ªáu, c√≥ th·ªÉ l·ªçc theo ng√†y, th√°ng, nƒÉm - ch·ªâ hi·ªÉn th·ªã c·ªßa user hi·ªán t·∫°i"""
    for row in tree.get_children():
        tree.delete(row)

    try:
        conn = get_connection()
        cursor = conn.cursor()

        query = "SELECT ID, Ngay, Danh_muc, So_tien, Ghi_chu FROM ChiTieu WHERE UserID = %s"
        params = [current_user_id]

        if ngay:
            query += " AND Ngay = %s"
            params.append(ngay)
        elif thang and nam:
            query += " AND MONTH(Ngay) = %s AND YEAR(Ngay) = %s"
            params.extend([thang, nam])
        elif nam:
            query += " AND YEAR(Ngay) = %s"
            params.append(nam)

        query += " ORDER BY Ngay DESC, ID DESC"
        cursor.execute(query, tuple(params))
        rows = cursor.fetchall()
        conn.close()

        for r in rows:
            # Format s·ªë ti·ªÅn
            formatted_row = list(r)
            formatted_row[3] = format_currency(r[3])  # Format s·ªë ti·ªÅn ·ªü c·ªôt th·ª© 3
            tree.insert("", tk.END, values=formatted_row)

    except Exception as e:
        messagebox.showerror("L·ªói DB", f"C√≥ l·ªói khi ƒë·ªçc d·ªØ li·ªáu:\n{e}")

def xoa_chi_tieu():
    selected = tree.selection()
    if not selected:
        messagebox.showwarning("Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn m·ªôt d√≤ng ƒë·ªÉ x√≥a.")
        return

    item = tree.item(selected[0])
    record_id = item['values'][0]

    if not messagebox.askyesno("X√°c nh·∫≠n", f"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi ti√™u ID = {record_id}?"):
        return

    try:
        conn = get_connection()
        cursor = conn.cursor()
        # Ki·ªÉm tra xem chi ti√™u c√≥ thu·ªôc v·ªÅ user hi·ªán t·∫°i kh√¥ng
        cursor.execute("SELECT UserID FROM ChiTieu WHERE ID = %s", (record_id,))
        result = cursor.fetchone()
        if result and result[0] == current_user_id:
            cursor.execute("DELETE FROM ChiTieu WHERE ID = %s", (record_id,))
            conn.commit()
            messagebox.showinfo("Th√†nh c√¥ng", "ƒê√£ x√≥a chi ti√™u.")
            hien_thi_du_lieu()
        else:
            messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ x√≥a chi ti√™u n√†y!")
        conn.close()
    except Exception as e:
        messagebox.showerror("L·ªói DB", f"Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu:\n{e}")


def sua_chi_tieu():
    """Ch·ª©c nƒÉng s·ª≠a chi ti√™u"""
    global editing_expense_id

    selected = tree.selection()
    if not selected:
        messagebox.showwarning("Ch∆∞a ch·ªçn", "Vui l√≤ng ch·ªçn m·ªôt d√≤ng ƒë·ªÉ s·ª≠a.")
        return

    item = tree.item(selected[0])
    record_id = item['values'][0]

    # Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT UserID FROM ChiTieu WHERE ID = %s", (record_id,))
        result = cursor.fetchone()
        conn.close()

        if not result or result[0] != current_user_id:
            messagebox.showerror("L·ªói", "Kh√¥ng th·ªÉ s·ª≠a chi ti√™u n√†y!")
            return
    except Exception as e:
        messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ ki·ªÉm tra quy·ªÅn s·ªü h·ªØu: {e}")
        return

    # L·∫•y th√¥ng tin chi ti√™u ƒë·ªÉ ƒëi·ªÅn v√†o form
    try:
        conn = get_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT Ngay, Danh_muc, So_tien, Ghi_chu FROM ChiTieu WHERE ID = %s", (record_id,))
        expense_data = cursor.fetchone()
        conn.close()

        if expense_data:
            editing_expense_id = record_id

            ngay_str = expense_data[0].strftime("%Y-%m-%d")  # Chuy·ªÉn datetime.date th√†nh string
            expense_data_processed = (ngay_str, expense_data[1], expense_data[2], expense_data[3])

            show_add_expense_window(expense_data_processed)  # Truy·ªÅn d·ªØ li·ªáu ƒë√£ x·ª≠ l√Ω v√†o form

    except Exception as e:
        messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ l·∫•y th√¥ng tin chi ti√™u: {e}")

def select_category(category, category_buttons):
    """X·ª≠ l√Ω khi ch·ªçn danh m·ª•c chi ti√™u"""
    global selected_category
    selected_category = category  # L∆∞u l·∫°i danh m·ª•c ƒë√£ ch·ªçn

    # ƒê·∫∑t l·∫°i m√†u cho t·∫•t c·∫£ n√∫t
    for cat, btn in category_buttons.items():
        btn.configure(bg=CATEGORY_COLORS.get(cat, "#FFFFFF"), fg="#333333", relief=tk.RAISED)

    # T√¥ s√°ng n√∫t ƒë∆∞·ª£c ch·ªçn
    category_buttons[category].configure(bg="#4FC3A1", fg="white", relief=tk.SUNKEN)


def show_add_expense_window(expense_data=None):
    """Hi·ªÉn th·ªã c·ª≠a s·ªï th√™m/s·ª≠a chi ti√™u ri√™ng bi·ªát"""
    global entry_ngay, entry_sotien, entry_ghichu, selected_category, category_buttons, editing_expense_id, add_window

    add_window = tk.Toplevel(root)

    # Thi·∫øt l·∫≠p ti√™u ƒë·ªÅ d·ª±a tr√™n ch·∫ø ƒë·ªô
    if expense_data:
        add_window.title("S·ª≠a chi ti√™u")
        window_title = "‚úèÔ∏è S·ª¨A CHI TI√äU"
        button_text = "üíæ C·∫≠p nh·∫≠t chi ti√™u"
    else:
        add_window.title("Th√™m chi ti√™u")
        window_title = "‚ûï TH√äM CHI TI√äU"
        button_text = "‚ûï Th√™m chi ti√™u"
        editing_expense_id = None  # ƒê·∫£m b·∫£o l√† ch·∫ø ƒë·ªô th√™m m·ªõi

    add_window.geometry("600x700")
    add_window.configure(bg="#F8F9FA")
    add_window.transient(root)
    add_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    add_window.update_idletasks()
    x = (add_window.winfo_screenwidth() // 2) - (600 // 2)
    y = (add_window.winfo_screenheight() // 2) - (700 // 2)
    add_window.geometry(f"600x700+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(add_window, text=window_title, font=FONT_TITLE, bg="#F8F9FA", fg="#333333").pack(pady=(20, 30))

    # Frame ch√≠nh
    main_frame = tk.Frame(add_window, bg="#F8F9FA")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=10)

    # ==== CH·ªåN NG√ÄY ====
    date_frame = tk.LabelFrame(main_frame, text="üìÖ Ch·ªçn ng√†y", font=FONT_SUBTITLE,
                               bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    date_frame.pack(fill=tk.X, pady=(0, 15))
    entry_ngay = DateEntry(date_frame, date_pattern='yyyy-mm-dd', font=FONT_NORMAL, width=20)
    entry_ngay.pack(pady=5)

    # ==== CH·ªåN DANH M·ª§C ====
    category_frame = tk.LabelFrame(main_frame, text="üóÇÔ∏è Ch·ªçn danh m·ª•c", font=FONT_SUBTITLE,
                                   bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    category_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 15))

    btn_container = tk.Frame(category_frame, bg="#FFFFFF")
    btn_container.pack(fill=tk.BOTH, expand=True, pady=10)

    category_buttons = {}
    total_cols = 3
    for i, category in enumerate(CATEGORIES):
        btn = tk.Button(
            btn_container,
            text=category,
            font=FONT_NORMAL,
            bg=CATEGORY_COLORS.get(category, "#FFFFFF"),
            fg="#333333",
            relief=tk.RAISED,
            bd=1,
            padx=20,
            pady=10,
            cursor="hand2",
            activebackground="#333333",
            activeforeground="#FFFFFF",
            command=lambda c=category: select_category(c, category_buttons)
        )
        btn.grid(row=i // total_cols, column=i % total_cols, padx=10, pady=10, sticky="nsew")
        category_buttons[category] = btn

    for j in range(total_cols):
        btn_container.columnconfigure(j, weight=1)

    # ==== S·ªê TI·ªÄN ====
    amount_frame = tk.LabelFrame(main_frame, text="üí∞ Nh·∫≠p s·ªë ti·ªÅn", font=FONT_SUBTITLE,
                                 bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    amount_frame.pack(fill=tk.X, pady=(0, 15))

    entry_sotien = tk.Entry(amount_frame, font=FONT_NORMAL, justify="right")
    entry_sotien.pack(fill=tk.X, padx=10, pady=5)

    def on_amount_change(event):
        raw = entry_sotien.get().replace(".", "")
        if not raw:
            return
        if raw.isdigit():
            caret = entry_sotien.index(tk.INSERT)
            formatted = format_currency(raw)
            entry_sotien.delete(0, tk.END)
            entry_sotien.insert(0, formatted)
            entry_sotien.icursor(min(caret, len(formatted)))

    entry_sotien.bind("<KeyRelease>", on_amount_change)

    # ==== GHI CH√ö ====
    note_frame = tk.LabelFrame(main_frame, text="üìù Ghi ch√∫", font=FONT_SUBTITLE,
                               bg="#FFFFFF", fg="#333333", padx=15, pady=10)
    note_frame.pack(fill=tk.X, pady=(0, 15))

    entry_ghichu = tk.Entry(note_frame, font=FONT_NORMAL)
    entry_ghichu.pack(fill=tk.X, padx=10, pady=5)

    # ==== N√öT CH√çNH ====
    btn_add = tk.Button(
        main_frame,
        text=button_text,
        command=lambda: [them_chi_tieu(), add_window.destroy() if not editing_expense_id else None],
        bg="#4FC3A1",
        fg="white",
        font=FONT_SUBTITLE,
        relief=tk.FLAT,
        cursor="hand2",
        padx=15,
        pady=10
    )
    btn_add.pack(pady=20, ipadx=10)

    # ==== ƒêI·ªÄN D·ªÆ LI·ªÜU N·∫æU ƒêANG S·ª¨A ====
    if expense_data:
        ngay, danh_muc, so_tien, ghi_chu = expense_data

        # ƒêi·ªÅn ng√†y
        entry_ngay.set_date(datetime.strptime(ngay, "%Y-%m-%d"))

        # ƒêi·ªÅn danh m·ª•c
        if danh_muc in category_buttons:
            select_category(danh_muc, category_buttons)

        # ƒêi·ªÅn s·ªë ti·ªÅn
        entry_sotien.delete(0, tk.END)
        entry_sotien.insert(0, format_currency(so_tien))

        # ƒêi·ªÅn ghi ch√∫
        entry_ghichu.delete(0, tk.END)
        if ghi_chu:
            entry_ghichu.insert(0, ghi_chu)


def show_view_expense_window():
    """Hi·ªÉn th·ªã c·ª≠a s·ªï xem chi ti√™u ri√™ng bi·ªát"""
    global tree, filter_ngay, filter_thang, filter_nam

    view_window = tk.Toplevel(root)
    view_window.title("Xem chi ti√™u")
    view_window.geometry("1000x600")
    view_window.configure(bg="#F5F5F5")
    view_window.transient(root)
    view_window.grab_set()

    # CƒÉn gi·ªØa c·ª≠a s·ªï
    view_window.update_idletasks()
    x = (view_window.winfo_screenwidth() // 2) - (1000 // 2)
    y = (view_window.winfo_screenheight() // 2) - (600 // 2)
    view_window.geometry(f"1000x600+{x}+{y}")

    # Ti√™u ƒë·ªÅ
    tk.Label(view_window, text="üìä XEM CHI TI√äU", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(20, 20))

    # Frame ch√≠nh
    main_frame = tk.Frame(view_window, bg="#F5F5F5")
    main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

    # Frame l·ªçc
    frame_filter = tk.LabelFrame(main_frame, text="L·ªçc d·ªØ li·ªáu", font=FONT_SUBTITLE, bg="#FFFFFF",
                                 fg="#333333", padx=15, pady=10)
    frame_filter.pack(fill=tk.X, pady=(0, 15))

    tk.Label(frame_filter, text="Ng√†y:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=0, padx=5)
    filter_ngay = DateEntry(frame_filter, date_pattern='yyyy-mm-dd', font=FONT_SMALL)
    filter_ngay.grid(row=0, column=1, padx=5)
    tk.Button(frame_filter, text="L·ªçc theo ng√†y",
              command=lambda: hien_thi_du_lieu(filter_ngay.get_date().strftime("%Y-%m-%d")),
              font=FONT_SMALL, bg="#B0E0E6", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=2, padx=5)

    tk.Label(frame_filter, text="Th√°ng:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=3, padx=5)
    filter_thang = ttk.Combobox(frame_filter, values=list(range(1, 13)), width=5, state="readonly",
                                font=FONT_SMALL)
    filter_thang.grid(row=0, column=4)
    filter_thang.set(datetime.now().month)

    tk.Label(frame_filter, text="NƒÉm:", font=FONT_NORMAL, bg="#FFFFFF").grid(row=0, column=5, padx=5)
    filter_nam = ttk.Combobox(frame_filter, values=list(range(2020, datetime.now().year + 1)), width=7,
                              state="readonly", font=FONT_SMALL)
    filter_nam.grid(row=0, column=6)
    filter_nam.set(datetime.now().year)

    tk.Button(frame_filter, text="L·ªçc theo th√°ng",
              command=lambda: hien_thi_du_lieu(None, int(filter_thang.get()), int(filter_nam.get())),
              font=FONT_SMALL, bg="#DDA0DD", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=7, padx=5)
    tk.Button(frame_filter, text="L·ªçc theo nƒÉm",
              command=lambda: hien_thi_du_lieu(None, None, int(filter_nam.get())),
              font=FONT_SMALL, bg="#F0E68C", fg="#333333", relief=tk.FLAT).grid(row=0, column=8, padx=5)
    tk.Button(frame_filter, text="Hi·ªÉn th·ªã t·∫•t c·∫£", command=hien_thi_du_lieu,
              font=FONT_SMALL, bg="#98D8C8", fg="#FFFFFF", relief=tk.FLAT).grid(row=0, column=9, padx=5)

    # B·∫£ng hi·ªÉn th·ªã
    frame_table = tk.Frame(main_frame, bg="#FFFFFF")
    frame_table.pack(fill=tk.BOTH, expand=True, pady=(0, 10))

    tree = ttk.Treeview(frame_table, columns=("ID", "Ng√†y", "Danh m·ª•c", "S·ªë ti·ªÅn", "Ghi ch√∫"), show="headings")
    tree.heading("ID", text="ID")
    tree.heading("Ng√†y", text="Ng√†y")
    tree.heading("Danh m·ª•c", text="Danh m·ª•c")
    tree.heading("S·ªë ti·ªÅn", text="S·ªë ti·ªÅn")
    tree.heading("Ghi ch√∫", text="Ghi ch√∫")
    tree.column("ID", width=50, anchor="center")
    tree.column("Ng√†y", width=120, anchor="center")
    tree.column("Danh m·ª•c", width=120)
    tree.column("S·ªë ti·ªÅn", width=150, anchor="e")
    tree.column("Ghi ch√∫", width=300)
    tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

    scrollbar = ttk.Scrollbar(frame_table, orient=tk.VERTICAL, command=tree.yview)
    tree.configure(yscrollcommand=scrollbar.set)
    scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

    # N√∫t ch·ª©c nƒÉng
    btn_frame = tk.Frame(main_frame, bg="#F5F5F5")
    btn_frame.pack(fill=tk.X)

    # Frame ch·ª©a 2 n√∫t
    button_container = tk.Frame(btn_frame, bg="#F5F5F5")
    button_container.pack(pady=10)

    # N√∫t s·ª≠a
    btn_edit = tk.Button(button_container, text="‚úèÔ∏è S·ª≠a chi ti√™u ƒë√£ ch·ªçn", command=sua_chi_tieu,
                         font=FONT_SUBTITLE, bg="#4FC3A1", fg="#FFFFFF", relief=tk.FLAT, padx=20, pady=10)
    btn_edit.pack(side=tk.LEFT, padx=10)

    # N√∫t x√≥a
    btn_delete = tk.Button(button_container, text="üóëÔ∏è X√≥a chi ti√™u ƒë√£ ch·ªçn", command=xoa_chi_tieu,
                           font=FONT_SUBTITLE, bg="#FFB6C1", fg="#FFFFFF", relief=tk.FLAT, padx=20, pady=10)
    btn_delete.pack(side=tk.LEFT, padx=10)

    # Hi·ªÉn th·ªã d·ªØ li·ªáu ban ƒë·∫ßu
    hien_thi_du_lieu()
