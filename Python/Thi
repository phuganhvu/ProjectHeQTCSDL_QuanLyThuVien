import tkinter as tk
from sklearn.linear_model import LinearRegression
from tkinter import messagebox, ttk
import pandas as pd
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from database import get_connection, init_database, check_login, register_user, get_all_users, delete_user
import matplotlib.pyplot as plt
from tkcalendar import DateEntry
from datetime import datetime

CATEGORIES = ["Ä‚n uá»‘ng", "Äi láº¡i", "Há»c táº­p", "Giáº£i trÃ­", "Mua sáº¯m", "KhÃ¡c"]
CATEGORY_COLORS = {
    "Ä‚n uá»‘ng": "#FFB6C1",
    "Äi láº¡i": "#B0E0E6",
    "Há»c táº­p": "#DDA0DD",
    "Giáº£i trÃ­": "#F0E68C",
    "Mua sáº¯m": "#98D8C8",
    "KhÃ¡c": "#FFDAB9"
}

FONT_TITLE = ("Segoe UI", 20, "bold")
FONT_SUBTITLE = ("Segoe UI", 12, "bold")
FONT_NORMAL = ("Segoe UI", 11)
FONT_SMALL = ("Segoe UI", 9)

# Biáº¿n toÃ n cá»¥c lÆ°u UserID vÃ  username cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i
current_user_id = None
current_username = None
selected_category = None
editing_expense_id = None


# ======== HÃ€M TIá»†N ÃCH ========
def format_currency(amount):
    """Format sá»‘ tiá»n vá»›i dáº¥u cháº¥m phÃ¢n cÃ¡ch, chá»‰ láº¥y Ä‘áº¿n hÃ ng Ä‘Æ¡n vá»‹"""
    if amount is None:
        return "0"
    try:
        amount_int = int(float(amount))
        return f"{amount_int:,}".replace(",", ".")
    except:
        return "0"


def parse_currency(text):
    """Chuyá»ƒn Ä‘á»•i text cÃ³ dáº¥u cháº¥m vá» sá»‘"""
    if not text:
        return 0
    try:
        # Loáº¡i bá» dáº¥u cháº¥m phÃ¢n cÃ¡ch
        text = text.replace(".", "")
        return float(text)
    except:
        return 0


# ======== CHá»¨C NÄ‚NG ÄÄ‚NG NHáº¬P ========
def create_rounded_button(parent, text, command, bg_color, fg_color="white", width=200, height=50):
    btn = tk.Button(parent, text=text, command=command, bg=bg_color, fg=fg_color,
                    font=FONT_SUBTITLE, width=width, height=height,
                    relief=tk.FLAT, cursor="hand2", bd=0,
                    activebackground=bg_color, activeforeground=fg_color)
    return btn


def show_login():
    for widget in root.winfo_children():
        widget.destroy()

    root.title("ÄÄƒng nháº­p - Quáº£n lÃ½ chi tiÃªu cÃ¡ nhÃ¢n")
    root.geometry("500x400")
    root.resizable(False, False)
    root.configure(bg="#F5F5F5")

    # CÄƒn giá»¯a cá»­a sá»•
    root.update_idletasks()
    x = (root.winfo_screenwidth() // 2) - (500 // 2)
    y = (root.winfo_screenheight() // 2) - (400 // 2)
    root.geometry(f"500x400+{x}+{y}")

    # Frame chÃ­nh
    frame_login = tk.Frame(root, bg="#F5F5F5")
    frame_login.pack(expand=True)

    tk.Label(frame_login, text="ÄÄ‚NG NHáº¬P", font=FONT_TITLE, bg="#F5F5F5", fg="#333333").pack(pady=(20, 30))

    # TÃªn Ä‘Äƒng nháº­p
    tk.Label(frame_login, text="TÃªn Ä‘Äƒng nháº­p:", font=FONT_NORMAL, bg="#F5F5F5", fg="#555555").pack(anchor="w", padx=80,
                                                                                                    pady=(0, 5))
    entry_username = tk.Entry(frame_login, width=30, font=FONT_NORMAL, relief=tk.FLAT, bd=3,
                              highlightthickness=1, highlightbackground="#DDD", highlightcolor="#98D8C8")
    entry_username.pack(pady=(0, 15))
    entry_username.focus()

    # Máº­t kháº©u
    tk.Label(frame_login, text="Máº­t kháº©u:", font=FONT_NORMAL, bg="#F5F5F5", fg="#555555").pack(anchor="w", padx=80,
                                                                                               pady=(0, 5))

    # Frame cho máº­t kháº©u vÃ  nÃºt hiá»ƒn thá»‹
    password_frame = tk.Frame(frame_login, bg="#F5F5F5")
    password_frame.pack(pady=(0, 20))

    entry_password = tk.Entry(password_frame, width=27, font=FONT_NORMAL, show="â€¢", relief=tk.FLAT, bd=3,
                              highlightthickness=1, highlightbackground="#DDD", highlightcolor="#98D8C8")
    entry_password.pack(side=tk.LEFT, padx=(0, 5))

    # Biáº¿n Ä‘á»ƒ theo dÃµi tráº¡ng thÃ¡i hiá»ƒn thá»‹ máº­t kháº©u
    password_visible = tk.BooleanVar(value=False)

    def toggle_password():
        if password_visible.get():
            # áº¨n máº­t kháº©u
            entry_password.config(show="â€¢")
            btn_show_password.config(text="ğŸ˜")
        else:
            # Hiá»ƒn thá»‹ máº­t kháº©u
            entry_password.config(show="")
            btn_show_password.config(text="ğŸ˜µ")
        password_visible.set(not password_visible.get())

    # NÃºt hiá»ƒn thá»‹ máº­t kháº©u
    btn_show_password = tk.Button(password_frame, text="ğŸ˜", command=toggle_password,
                                  font=("Segoe UI", 11), bg="#E0E0E0", fg="#555555",
                                  relief=tk.FLAT, width=2, height=1,
                                  activebackground="#D0D0D0", activeforeground="#333333")
    btn_show_password.pack(side=tk.LEFT)

    # ====== HÃ€M Xá»¬ LÃ ======
    def login():
        global current_user_id, current_username
        username = entry_username.get().strip()
        password = entry_password.get().strip()

        if not username or not password:
            messagebox.showwarning("Thiáº¿u thÃ´ng tin", "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u!")
            return

        user_id = check_login(username, password)
        if user_id:
            current_user_id = user_id
            current_username = username
            messagebox.showinfo("ThÃ nh cÃ´ng", f"ÄÄƒng nháº­p thÃ nh cÃ´ng!\nXin chÃ o, {username}!")
            show_home_page()
        else:
            messagebox.showerror("Lá»—i Ä‘Äƒng nháº­p", "TÃªn Ä‘Äƒng nháº­p hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng!")

    def register():
        username = entry_username.get().strip()
        password = entry_password.get().strip()

        if not username or not password:
            messagebox.showwarning("Thiáº¿u thÃ´ng tin", "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tÃªn Ä‘Äƒng nháº­p vÃ  máº­t kháº©u!")
            return
        if len(password) < 4:
            messagebox.showwarning("Máº­t kháº©u yáº¿u", "Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 4 kÃ½ tá»±!")
            return

        if register_user(username, password):
            messagebox.showinfo("ThÃ nh cÃ´ng", "ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.")
            entry_password.delete(0, tk.END)
        else:
            messagebox.showerror("Lá»—i Ä‘Äƒng kÃ½", "TÃªn Ä‘Äƒng nháº­p Ä‘Ã£ tá»“n táº¡i!")

    # ====== Hai nÃºt Ä‘Äƒng nháº­p & Ä‘Äƒng kÃ½ ======
    frame_buttons = tk.Frame(frame_login, bg="#F5F5F5")
    frame_buttons.pack(pady=15)

    def style_button(btn, bg, fg, border, hover_bg):
        btn.configure(
            bg=bg,
            fg=fg,
            font=("Segoe UI", 11, "bold"),
            relief="flat",
            bd=0,
            width=12,
            height=1,
            highlightthickness=1,
            highlightbackground=border,
            cursor="hand2",
            activebackground=hover_bg,
            activeforeground="#FFFFFF"
        )

    # Táº¡o nÃºt
    btn_login = tk.Button(frame_buttons, text="ÄÄƒng nháº­p", command=login)
    btn_register = tk.Button(frame_buttons, text="ÄÄƒng kÃ½", command=register)

    # GÃ¡n style
    style_button(btn_login, bg="#4FC3A1", fg="#FFFFFF", border="#3CA48A", hover_bg="#3CA48A")
    style_button(btn_register, bg="#D8B4E2", fg="#FFFFFF", border="#B685C5", hover_bg="#B685C5")

    # Hiá»‡u á»©ng bo gÃ³c
    btn_login.configure(font=("Segoe UI", 11, "bold"), relief="flat")
    btn_register.configure(font=("Segoe UI", 11, "bold"), relief="flat")

    # Äáº·t ngang hÃ ng
    btn_login.grid(row=0, column=0, padx=10)
    btn_register.grid(row=0, column=1, padx=10)




def show_home_page():
    """Hiá»ƒn thá»‹ trang chá»§ vá»›i 3 nÃºt chá»©c nÄƒng chÃ­nh"""
    # Kiá»ƒm tra náº¿u lÃ  admin thÃ¬ hiá»ƒn thá»‹ giao diá»‡n quáº£n lÃ½ users
    if current_username == "admin":
        show_admin_panel()
        return

    # XÃ³a táº¥t cáº£ widget cÅ©
    for widget in root.winfo_children():
        widget.destroy()

    root.title("Trang chá»§ - Quáº£n lÃ½ chi tiÃªu cÃ¡ nhÃ¢n")
    root.geometry("1000x750")
    root.resizable(True, True)  # Sá»¬A Tá»ª KHÃ”NG CÃ“ THÃ€NH CÃ“
    root.configure(bg="#F5F5F5")

    # Header vá»›i avatar vÃ  thÃ´ng tin
    header_frame = tk.Frame(root, bg="#FFFFFF", height=150)
    header_frame.pack(fill=tk.X, padx=0, pady=0)
    header_frame.pack_propagate(False)

    # Avatar
    avatar_frame = tk.Frame(header_frame, bg="#FFFFFF")
    avatar_frame.pack(side=tk.LEFT, padx=30, pady=20)

    avatar_canvas = tk.Canvas(avatar_frame, width=100, height=100, bg="#FFFFFF", highlightthickness=0)
    avatar_canvas.pack()
    avatar_canvas.create_oval(5, 5, 95, 95, fill="#98D8C8", outline="#98D8C8", width=2)
    avatar_canvas.create_text(50, 50, text=current_username[0].upper(), font=("Segoe UI", 40, "bold"), fill="#FFFFFF")

    # ThÃ´ng tin tÃ i khoáº£n
    info_frame = tk.Frame(header_frame, bg="#FFFFFF")
    info_frame.pack(side=tk.LEFT, padx=20, pady=20, anchor="w")

    tk.Label(info_frame, text=f"Xin chÃ o, {current_username}!", font=FONT_TITLE, bg="#FFFFFF", fg="#333333").pack(
        anchor="w")
    tk.Label(info_frame, text=f"TÃ i khoáº£n: {current_username}", font=FONT_NORMAL, bg="#FFFFFF", fg="#666666").pack(
        anchor="w", pady=(5, 0))

    # NÃºt Ä‘Äƒng xuáº¥t
    logout_btn = tk.Button(header_frame, text="ÄÄƒng xuáº¥t", command=logout, bg="#FFB6C1", fg="#FFFFFF",
                           font=FONT_SMALL, relief=tk.FLAT, cursor="hand2", padx=15, pady=5)
    logout_btn.pack(side=tk.RIGHT, padx=30, pady=20)

    # Thá»‘ng kÃª tá»•ng quan
    stats_frame = tk.Frame(root, bg="#F5F5F5", padx=20, pady=20)
    stats_frame.pack(fill=tk.X)

    total_expenses = get_total_expenses()
    expense_count = get_expense_count()
    monthly_expense = get_monthly_expense()

    # Táº¡o 3 card thá»‘ng kÃª trong grid
    cards_container = tk.Frame(stats_frame, bg="#F5F5F5")
    cards_container.pack(fill=tk.X)

    stats_data = [
        ("Tá»•ng chi tiÃªu", f"{format_currency(total_expenses)} VNÄ", "#4FC3A1"),
        ("Sá»‘ lÆ°á»£ng chi tiÃªu", f"{expense_count} giao dá»‹ch", "#DDA0DD"),
        ("Chi tiÃªu thÃ¡ng nÃ y", f"{format_currency(monthly_expense)} VNÄ", "#FFB6C1")
    ]

    for i, (title, value, color) in enumerate(stats_data):
        card = tk.Frame(cards_container, bg=color, relief=tk.RAISED, bd=2, padx=20, pady=15)
        card.grid(row=0, column=i, padx=5, sticky="nsew")
        cards_container.columnconfigure(i, weight=1)

        tk.Label(card, text=title, font=FONT_SMALL, bg=color, fg="white").pack()
        tk.Label(card, text=value, font=("Segoe UI", 14, "bold"),
                 bg=color, fg="white").pack(pady=(5, 0))

    # ====== 3 NÃšT CHá»¨C NÄ‚NG CHÃNH ======
    buttons_frame = tk.Frame(root, bg="#F5F5F5")
    buttons_frame.pack(fill=tk.BOTH, expand=True, padx=50, pady=30)

    def create_feature_button(parent, text, command, color):
        btn = tk.Button(
            parent,
            text=text,
            command=command,
            bg=color,
            fg="white",
            font=("Segoe UI", 16, "bold"),
            relief=tk.FLAT,
            cursor="hand2",
            padx=15,
            pady=12,
            width=20
        )
        return btn

    # NÃºt 1: ThÃªm chi tiÃªu
    btn_add = create_feature_button(buttons_frame, "â• THÃŠM CHI TIÃŠU",
                                    show_add_expense_window, "#4FC3A1")
    btn_add.pack(pady=10, fill=tk.X)

    # NÃºt 2: Xem chi tiÃªu
    btn_view = create_feature_button(buttons_frame, "ğŸ“Š XEM CHI TIÃŠU",
                                     show_view_expense_window, "#DDA0DD")
    btn_view.pack(pady=10, fill=tk.X)

    # NÃºt 3: Biá»ƒu Ä‘á»“
    btn_chart = create_feature_button(buttons_frame, "ğŸ“ˆ BIá»‚U Äá»’",
                                      show_chart_window, "#FFB6C1")
    btn_chart.pack(pady=10, fill=tk.X)

    # 2 NÃšT
    ai_frame = tk.Frame(buttons_frame, bg="#F5F5F5")
    ai_frame.pack(fill=tk.X, pady=10)

    btn_chatbot = create_feature_button(ai_frame, "ğŸ¤– TRá»¢ LÃ TÃ€I CHÃNH", chatbot_tu_van, "#6A5ACD")
    btn_chatbot.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=5)

    btn_warning = create_feature_button(ai_frame, "ğŸš¨ Cáº¢NH BÃO", ai_canh_bao_bat_thuong, "#FF6B6B")
    btn_warning.pack(side=tk.RIGHT, fill=tk.X, expand=True, padx=5)

def logout():
    """ÄÄƒng xuáº¥t"""
    global current_user_id, current_username, selected_category
    if messagebox.askyesno("XÃ¡c nháº­n", "Báº¡n cÃ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t?"):
        current_user_id = None
        current_username = None
        selected_category = None
        show_login()

# ======== CHá»¨C NÄ‚NG QUáº¢N LÃ USER ========
def hien_thi_users():
    """Hiá»ƒn thá»‹ danh sÃ¡ch users"""
    global tree_users
    for row in tree_users.get_children():
        tree_users.delete(row)
    try:
        users = get_all_users()
        for user_id, username, password in users:
            tree_users.insert("", tk.END, values=(user_id, username, password))
    except Exception as e:
        messagebox.showerror("Lá»—i DB", f"CÃ³ lá»—i khi Ä‘á»c dá»¯ liá»‡u:\n{e}")

def xoa_user():
    """XÃ³a user"""
    global tree_users
    selected = tree_users.selection()
    if not selected:
        messagebox.showwarning("ChÆ°a chá»n", "Vui lÃ²ng chá»n má»™t user Ä‘á»ƒ xÃ³a.")
        return

    item = tree_users.item(selected[0])
    user_id = item['values'][0]
    username = item['values'][1]

    if username == "admin":
        messagebox.showwarning("KhÃ´ng thá»ƒ xÃ³a", "KhÃ´ng thá»ƒ xÃ³a tÃ i khoáº£n admin!")
        return

    if not messagebox.askyesno("XÃ¡c nháº­n",
                               f"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a user '{username}' (ID: {user_id})?\nTáº¥t cáº£ chi tiÃªu cá»§a user nÃ y cÅ©ng sáº½ bá»‹ xÃ³a!"):
        return

    if delete_user(user_id):
        messagebox.showinfo("ThÃ nh cÃ´ng", f"ÄÃ£ xÃ³a user '{username}'!")
        hien_thi_users()
    else:
        messagebox.showerror("Lá»—i", "KhÃ´ng thá»ƒ xÃ³a user nÃ y!")

def show_admin_panel():
    for widget in root.winfo_children():
        widget.destroy()

    root.title("Quáº£n lÃ½ tÃ i khoáº£n ngÆ°á»i dÃ¹ng - Admin")
    root.geometry("700x500")
    root.resizable(True, True)

    title_frame = tk.Frame(root)
    title_frame.pack(pady=10)
    tk.Label(title_frame, text="QUáº¢N LÃ TÃ€I KHOáº¢N NGÆ¯á»œI DÃ™NG", font=("Arial", 16, "bold")).pack()
    tk.Label(title_frame, text="(Cháº¿ Ä‘á»™ Admin)", font=("Arial", 10), fg="gray").pack()

    # Báº£ng hiá»ƒn thá»‹ users
    global tree_users
    frame_table = tk.Frame(root)
    frame_table.pack(pady=10, padx=10, fill=tk.BOTH, expand=True)

    tree_users = ttk.Treeview(frame_table, columns=("ID", "Username", "Password"), show="headings")
    tree_users.heading("ID", text="ID")
    tree_users.heading("Username", text="TÃªn Ä‘Äƒng nháº­p")
    tree_users.heading("Password", text="Máº­t kháº©u")
    tree_users.column("ID", width=80, anchor="center")
    tree_users.column("Username", width=200, anchor="center")
    tree_users.column("Password", width=200, anchor="center")
    tree_users.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

    # Scrollbar
    scrollbar_users = ttk.Scrollbar(frame_table, orient=tk.VERTICAL, command=tree_users.yview)
    tree_users.configure(yscrollcommand=scrollbar_users.set)
    scrollbar_users.pack(side=tk.RIGHT, fill=tk.Y)

    # NÃºt chá»©c nÄƒng
    btn_frame = tk.Frame(root)
    btn_frame.pack(pady=10)

    tk.Button(btn_frame, text="LÃ m má»›i", command=hien_thi_users, width=15).pack(side=tk.LEFT, padx=5)
    tk.Button(btn_frame, text="XÃ³a user", command=xoa_user, width=15, fg="red").pack(side=tk.LEFT, padx=5)
    tk.Button(btn_frame, text="ÄÄƒng xuáº¥t", command=logout, width=15, fg="blue").pack(side=tk.LEFT, padx=5)
    hien_thi_users()

# ======== KHá»I Táº O á»¨NG Dá»¤NG ========
root = tk.Tk()
root.title("Quáº£n lÃ½ chi tiÃªu cÃ¡ nhÃ¢n - ÄÄƒng nháº­p")
root.geometry("400x250")
root.resizable(True, True)

# Khá»Ÿi táº¡o database
try:
    init_database()
except Exception as e:
    messagebox.showerror("Lá»—i", f"KhÃ´ng thá»ƒ káº¿t ná»‘i database:\n{e}")

show_login()
root.mainloop()

