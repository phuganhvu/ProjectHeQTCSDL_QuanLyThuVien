import mysql.connector

def get_connection():
    """K·∫øt n·ªëi MySQL"""
    return mysql.connector.connect(
        host="localhost",
        user="root",        # user MySQL c·ªßa b·∫°n
        password="123456789",  # m·∫≠t kh·∫©u (n·∫øu c√≥)
        database="ChiTieuDB"
    )

def init_database():
    """T·∫°o b·∫£ng ng∆∞·ªùi d√πng (Users) n·∫øu ch∆∞a c√≥"""
    conn = None
    try:
        conn = get_connection()
        with conn.cursor() as cur:
            # B·∫£ng Users
            cur.execute("""
                CREATE TABLE IF NOT EXISTS Users (
                    UserID INT AUTO_INCREMENT PRIMARY KEY,
                    Username VARCHAR(50) UNIQUE NOT NULL,
                    Password VARCHAR(255) NOT NULL
                )
            """)
            # T·∫°o b·∫£ng ChiTieu n·∫øu ch∆∞a c√≥
            cur.execute("""
                CREATE TABLE IF NOT EXISTS ChiTieu (
                    ID INT AUTO_INCREMENT PRIMARY KEY,
                    Ngay DATE NOT NULL,
                    Danh_muc VARCHAR(50),
                    So_tien DECIMAL(15,2),
                    Ghi_chu TEXT,
                    UserID INT
                )
            """)
            # Ki·ªÉm tra ChiTieu c√≥ UserID ch∆∞a
            cur.execute("SHOW COLUMNS FROM ChiTieu LIKE 'UserID'")
            if not cur.fetchone():
                cur.execute("ALTER TABLE ChiTieu ADD COLUMN UserID INT")
        conn.commit()
    except Exception as e:
        print("Loi khoi tao database:", e)
    finally:
        if conn:
            conn.close()

def check_login(username, password):
    """Ki·ªÉm tra ƒëƒÉng nh·∫≠p"""
    conn = None
    try:
        conn = get_connection()
        with conn.cursor() as cur:
            cur.execute("SELECT UserID, Password FROM Users WHERE Username = %s", (username,))
            result = cur.fetchone()
        if result and result[1] == password:
            return result[0]
        return None
    except Exception as e:
        print("Loi dang nhap:", e)
        return None
    finally:
        if conn:
            conn.close()

def register_user(username, password):
    """ƒêƒÉng k√Ω ng∆∞·ªùi d√πng m·ªõi"""
    conn = None
    try:
        conn = get_connection()
        with conn.cursor() as cur:
            cur.execute("SELECT 1 FROM Users WHERE Username = %s", (username,))
            if cur.fetchone():
                return False  # T√™n ƒë√£ t·ªìn t·∫°i
            cur.execute("INSERT INTO Users (Username, Password) VALUES (%s, %s)", (username, password))
        conn.commit()
        return True
    except Exception as e:
        print("Loi dang ky:", e)
        return False
    finally:
        if conn:
            conn.close()

def get_username(user_id):
    """L·∫•y t√™n ng∆∞·ªùi d√πng t·ª´ UserID"""
    conn = None
    try:
        conn = get_connection()
        with conn.cursor() as cur:
            cur.execute("SELECT Username FROM Users WHERE UserID = %s", (user_id,))
            result = cur.fetchone()
        return result[0] if result else None
    except Exception as e:
        print("Loi lay ten nguoi dung:", e)
        return None
    finally:
        if conn:
            conn.close()

def get_all_users():
    """L·∫•y danh s√°ch t·∫•t c·∫£ user"""
    conn = None
    try:
        conn = get_connection()
        with conn.cursor() as cur:
            cur.execute("SELECT UserID, Username, Password FROM Users ORDER BY UserID")
            return cur.fetchall()
    except Exception as e:
        print("Loi lay danh sach user:", e)
        return []
    finally:
        if conn:
            conn.close()

def delete_user(user_id):
    """X√≥a ng∆∞·ªùi d√πng (kh√¥ng x√≥a admin)"""
    conn = None
    try:
        conn = get_connection()
        with conn.cursor() as cur:
            cur.execute("SELECT Username FROM Users WHERE UserID = %s", (user_id,))
            result = cur.fetchone()
            if result and result[0] == "admin":
                return False
            cur.execute("DELETE FROM ChiTieu WHERE UserID = %s", (user_id,))
            cur.execute("DELETE FROM Users WHERE UserID = %s", (user_id,))
        conn.commit()
        return True
    except Exception as e:
        print("Loi xoa user:", e)
        return False
    finally:
        if conn:
            conn.close()





def ai_canh_bao_bat_thuong():
    """Ph√°t hi·ªán chi ti√™u b·∫•t th∆∞·ªùng so v·ªõi th√≥i quen"""
    try:
        conn = get_connection()
        cursor = conn.cursor()

        # L·∫•y chi ti√™u 6 th√°ng g·∫ßn nh·∫•t theo danh m·ª•c
        cursor.execute("""
            SELECT YEAR(Ngay) as nam, MONTH(Ngay) as thang, 
                   Danh_muc, SUM(So_tien) as tong_thang
            FROM ChiTieu 
            WHERE UserID = %s 
            GROUP BY YEAR(Ngay), MONTH(Ngay), Danh_muc
            ORDER BY nam DESC, thang DESC
            LIMIT 30  # L·∫•y nhi·ªÅu h∆°n ƒë·ªÉ ph√¢n t√≠ch
        """, (current_user_id,))

        all_data = cursor.fetchall()
        conn.close()

        if len(all_data) < 3:
            return "üìä C·∫ßn th√™m d·ªØ li·ªáu chi ti√™u ƒë·ªÉ ph√¢n t√≠ch c·∫£nh b√°o!"

        # Nh√≥m d·ªØ li·ªáu theo danh m·ª•c
        from collections import defaultdict
        category_data = defaultdict(list)

        for nam, thang, danh_muc, tong_thang in all_data:
            category_data[danh_muc].append((nam, thang, float(tong_thang)))

        # Ph√¢n t√≠ch b·∫•t th∆∞·ªùng cho t·ª´ng danh m·ª•c
        warnings = []

        for category, data in category_data.items():
            if len(data) < 2:  # C·∫ßn √≠t nh·∫•t 2 th√°ng ƒë·ªÉ so s√°nh
                continue

            current_month = data[0]  # Th√°ng g·∫ßn nh·∫•t
            previous_months = data[1:]  # C√°c th√°ng tr∆∞·ªõc

            # T√≠nh trung b√¨nh c√°c th√°ng tr∆∞·ªõc (lo·∫°i b·ªè gi√° tr·ªã ngo·∫°i lai)
            amounts = [amount for _, _, amount in previous_months]
            if not amounts:
                continue

            avg_previous = sum(amounts) / len(amounts)
            current_amount = current_month[2]

            # Ng∆∞·ª°ng c·∫£nh b√°o: tƒÉng 100% so v·ªõi trung b√¨nh
            if current_amount > avg_previous * 2.0 and current_amount > 500000:  # Tr√™n 500k v√† tƒÉng 100%
                increase_pct = ((current_amount - avg_previous) / avg_previous) * 100
                warnings.append({
                    'category': category,
                    'current': current_amount,
                    'average': avg_previous,
                    'increase': increase_pct,
                    'month': f"{current_month[1]:02d}/{current_month[0]}"
                })

        # T·∫°o c·ª≠a s·ªï c·∫£nh b√°o
        warning_window = tk.Toplevel(root)
        warning_window.title("üö® C·∫£nh B√°o Chi Ti√™u B·∫•t Th∆∞·ªùng")
        warning_window.geometry("700x500")
        warning_window.configure(bg="#FFF0F0")
        warning_window.transient(root)
        warning_window.grab_set()

        # CƒÉn gi·ªØa
        warning_window.update_idletasks()
        x = (warning_window.winfo_screenwidth() // 2) - (700 // 2)
        y = (warning_window.winfo_screenheight() // 2) - (500 // 2)
        warning_window.geometry(f"700x500+{x}+{y}")

        # Header
        header_frame = tk.Frame(warning_window, bg="#FF6B6B", height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)

        tk.Label(header_frame, text="üö® C·∫¢NH B√ÅO CHI TI√äU B·∫§T TH∆Ø·ªúNG",
                 font=("Segoe UI", 18, "bold"), bg="#FF6B6B", fg="white").pack(pady=20)

        # N·ªôi dung c·∫£nh b√°o
        content_frame = tk.Frame(warning_window, bg="#FFF0F0", padx=20, pady=20)
        content_frame.pack(fill=tk.BOTH, expand=True)

        if warnings:
            # S·∫Øp x·∫øp theo m·ª©c ƒë·ªô tƒÉng
            warnings.sort(key=lambda x: x['increase'], reverse=True)

            for i, warning in enumerate(warnings):
                warning_frame = tk.Frame(content_frame, bg="#FFE0E0", relief=tk.RAISED, bd=1, pady=10)
                warning_frame.pack(fill=tk.X, pady=5)

                # Icon c·∫£nh b√°o
                tk.Label(warning_frame, text="‚ö†Ô∏è", font=("Arial", 16),
                         bg="#FFE0E0").pack(side=tk.LEFT, padx=10)

                # Th√¥ng tin c·∫£nh b√°o
                info_frame = tk.Frame(warning_frame, bg="#FFE0E0")
                info_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)

                tk.Label(info_frame,
                         text=f"Chi ti√™u {warning['category']} th√°ng {warning['month']}",
                         font=("Segoe UI", 12, "bold"), bg="#FFE0E0", fg="#D63031").pack(anchor="w")

                tk.Label(info_frame,
                         text=f"TƒÉng {warning['increase']:.0f}% so v·ªõi trung b√¨nh",
                         font=("Segoe UI", 10), bg="#FFE0E0", fg="#E17055").pack(anchor="w")

                tk.Label(info_frame,
                         text=f"Hi·ªán t·∫°i: {format_currency(warning['current'])} | Trung b√¨nh: {format_currency(warning['average'])}",
                         font=("Segoe UI", 9), bg="#FFE0E0", fg="#666666").pack(anchor="w")

            # L·ªùi khuy√™n
            advice_frame = tk.Frame(content_frame, bg="#FFF0F0", pady=20)
            advice_frame.pack(fill=tk.X)

            advice_text = """üí° **L·ªúI KHUY√äN:**
‚Ä¢ Ki·ªÉm tra l·∫°i chi ti√™u cho c√°c danh m·ª•c tr√™n
‚Ä¢ Xem x√©t c·∫Øt gi·∫£m n·∫øu kh√¥ng th·ª±c s·ª± c·∫ßn thi·∫øt  
‚Ä¢ Thi·∫øt l·∫≠p ng√¢n s√°ch cho t·ª´ng danh m·ª•c"""

            tk.Label(advice_frame, text=advice_text, font=FONT_NORMAL,
                     bg="#FFF0F0", fg="#2D3436", justify=tk.LEFT).pack(anchor="w")

        else:
            # Kh√¥ng c√≥ c·∫£nh b√°o
            success_frame = tk.Frame(content_frame, bg="#E8F5E8", relief=tk.RAISED, bd=1, pady=30)
            success_frame.pack(fill=tk.BOTH, expand=True)

            tk.Label(success_frame, text="‚úÖ", font=("Arial", 48),
                     bg="#E8F5E8", fg="#27AE60").pack(pady=10)
            tk.Label(success_frame, text="KH√îNG C√ì C·∫¢NH B√ÅO N√ÄO",
                     font=("Segoe UI", 16, "bold"), bg="#E8F5E8", fg="#27AE60").pack()
            tk.Label(success_frame, text="Chi ti√™u c·ªßa b·∫°n ƒëang trong t·∫ßm ki·ªÉm so√°t!",
                     font=FONT_NORMAL, bg="#E8F5E8", fg="#666666").pack(pady=10)

        # N√∫t ƒë√≥ng
        btn_close = tk.Button(warning_window, text="ƒê√≥ng",
                              command=warning_window.destroy,
                              bg="#4FC3A1", fg="white", font=FONT_SUBTITLE,
                              relief=tk.FLAT, padx=30, pady=10)
        btn_close.pack(pady=20)

    except Exception as e:
        messagebox.showerror("L·ªói", f"Kh√¥ng th·ªÉ ph√¢n t√≠ch c·∫£nh b√°o: {str(e)}")
